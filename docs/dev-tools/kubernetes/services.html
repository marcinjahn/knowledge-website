<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Services | Marcin Jahn | Technology Notebook</title>
    <meta name="generator" content="VuePress 1.8.2">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-ZSM2N36X8P"></script>
    <script>(function() { if (window.location.href.startsWith('http://localhost')) { return; } window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-ZSM2N36X8P'); })();</script>
    <meta name="description" content="Service object in Kubernetes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.2d0603d3.css" as="style"><link rel="preload" href="/assets/js/app.87cbde57.js" as="script"><link rel="preload" href="/assets/js/2.f59378ff.js" as="script"><link rel="preload" href="/assets/js/4.e66cdc67.js" as="script"><link rel="prefetch" href="/assets/js/10.404a5336.js"><link rel="prefetch" href="/assets/js/11.26ad847d.js"><link rel="prefetch" href="/assets/js/12.f99024fc.js"><link rel="prefetch" href="/assets/js/13.7595fe03.js"><link rel="prefetch" href="/assets/js/14.19f0a33c.js"><link rel="prefetch" href="/assets/js/15.edd580e7.js"><link rel="prefetch" href="/assets/js/16.709a76fa.js"><link rel="prefetch" href="/assets/js/17.d31682fa.js"><link rel="prefetch" href="/assets/js/18.d418f3ca.js"><link rel="prefetch" href="/assets/js/19.5b6bae1a.js"><link rel="prefetch" href="/assets/js/20.b1296514.js"><link rel="prefetch" href="/assets/js/21.d9a411b5.js"><link rel="prefetch" href="/assets/js/22.a73f3628.js"><link rel="prefetch" href="/assets/js/23.e152ce40.js"><link rel="prefetch" href="/assets/js/24.f859344d.js"><link rel="prefetch" href="/assets/js/25.be380422.js"><link rel="prefetch" href="/assets/js/26.e729f0e8.js"><link rel="prefetch" href="/assets/js/27.6ebfc58b.js"><link rel="prefetch" href="/assets/js/28.10c80a6b.js"><link rel="prefetch" href="/assets/js/29.80ac4173.js"><link rel="prefetch" href="/assets/js/3.17bc78ba.js"><link rel="prefetch" href="/assets/js/30.62e3c796.js"><link rel="prefetch" href="/assets/js/31.2901ad07.js"><link rel="prefetch" href="/assets/js/32.9cfa42d9.js"><link rel="prefetch" href="/assets/js/33.e2569108.js"><link rel="prefetch" href="/assets/js/34.8eefdba7.js"><link rel="prefetch" href="/assets/js/35.641ef4db.js"><link rel="prefetch" href="/assets/js/36.59cd48b1.js"><link rel="prefetch" href="/assets/js/37.b140d4b6.js"><link rel="prefetch" href="/assets/js/38.338e0e7f.js"><link rel="prefetch" href="/assets/js/39.23590df6.js"><link rel="prefetch" href="/assets/js/40.d466dbc4.js"><link rel="prefetch" href="/assets/js/41.5b7d690d.js"><link rel="prefetch" href="/assets/js/42.c5526cf9.js"><link rel="prefetch" href="/assets/js/43.2d43a97b.js"><link rel="prefetch" href="/assets/js/44.55a58cf6.js"><link rel="prefetch" href="/assets/js/45.e90670ee.js"><link rel="prefetch" href="/assets/js/46.dbd4de3e.js"><link rel="prefetch" href="/assets/js/47.a6b24d05.js"><link rel="prefetch" href="/assets/js/48.547dd4f8.js"><link rel="prefetch" href="/assets/js/49.b38e8d7e.js"><link rel="prefetch" href="/assets/js/5.8fb6c804.js"><link rel="prefetch" href="/assets/js/50.85d4adbd.js"><link rel="prefetch" href="/assets/js/51.70928b4e.js"><link rel="prefetch" href="/assets/js/52.6cf81f03.js"><link rel="prefetch" href="/assets/js/53.43cdd428.js"><link rel="prefetch" href="/assets/js/54.c4ec2f87.js"><link rel="prefetch" href="/assets/js/55.d67fba02.js"><link rel="prefetch" href="/assets/js/56.beac5e77.js"><link rel="prefetch" href="/assets/js/57.4de3d728.js"><link rel="prefetch" href="/assets/js/58.cecb3823.js"><link rel="prefetch" href="/assets/js/59.2ec1381f.js"><link rel="prefetch" href="/assets/js/6.b38701ec.js"><link rel="prefetch" href="/assets/js/60.fed14f90.js"><link rel="prefetch" href="/assets/js/61.fed6147c.js"><link rel="prefetch" href="/assets/js/62.0583a533.js"><link rel="prefetch" href="/assets/js/63.da61b917.js"><link rel="prefetch" href="/assets/js/64.ae259b46.js"><link rel="prefetch" href="/assets/js/65.7de73bc1.js"><link rel="prefetch" href="/assets/js/66.bad1db68.js"><link rel="prefetch" href="/assets/js/67.d092e753.js"><link rel="prefetch" href="/assets/js/68.4f358bb8.js"><link rel="prefetch" href="/assets/js/69.087f8831.js"><link rel="prefetch" href="/assets/js/7.b6d31f4a.js"><link rel="prefetch" href="/assets/js/70.b49f2502.js"><link rel="prefetch" href="/assets/js/71.f15d3809.js"><link rel="prefetch" href="/assets/js/72.ebf1c946.js"><link rel="prefetch" href="/assets/js/73.205df904.js"><link rel="prefetch" href="/assets/js/74.76d73623.js"><link rel="prefetch" href="/assets/js/75.81c76e90.js"><link rel="prefetch" href="/assets/js/76.ec39a638.js"><link rel="prefetch" href="/assets/js/8.f2bdf25f.js"><link rel="prefetch" href="/assets/js/9.ef330b20.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2d0603d3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar boxshadow"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Marcin Jahn | Technology Notebook</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/programming/" class="nav-link">
  Programming
</a></div><div class="nav-item"><a href="/dev-tools/" class="nav-link router-link-active">
  Dev Tools
</a></div><div class="nav-item"><a href="/computers/" class="nav-link">
  Computers
</a></div><div class="nav-item"><a href="/meta/" class="nav-link">
  Meta
</a></div> <span class="external-services" data-v-6c2342f8><a target="_blank" href="https://www.linkedin.com/in/marcin-jahn-63a9b915b" data-v-dca26bee data-v-6c2342f8><img src="/img/linkedin.webp" data-v-dca26bee></a><a target="_blank" href="https://github.com/marcinjahn" data-v-dca26bee data-v-6c2342f8><img src="/img/github.webp" data-v-dca26bee></a></span> <a href="https://github.com/marcinjahn/knowledge-website" target="_blank" rel="noopener noreferrer" class="repo-link">
    Code on GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/programming/" class="nav-link">
  Programming
</a></div><div class="nav-item"><a href="/dev-tools/" class="nav-link router-link-active">
  Dev Tools
</a></div><div class="nav-item"><a href="/computers/" class="nav-link">
  Computers
</a></div><div class="nav-item"><a href="/meta/" class="nav-link">
  Meta
</a></div> <span class="external-services" data-v-6c2342f8><a target="_blank" href="https://www.linkedin.com/in/marcin-jahn-63a9b915b" data-v-dca26bee data-v-6c2342f8><img src="/img/linkedin.webp" data-v-dca26bee></a><a target="_blank" href="https://github.com/marcinjahn" data-v-dca26bee data-v-6c2342f8><img src="/img/github.webp" data-v-dca26bee></a></span> <a href="https://github.com/marcinjahn/knowledge-website" target="_blank" rel="noopener noreferrer" class="repo-link">
    Code on GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/dev-tools/" aria-current="page" class="sidebar-link">/dev-tools/</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Kubernetes</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev-tools/kubernetes/meaning.html" class="sidebar-link">Meaning and Purpose</a></li><li><a href="/dev-tools/kubernetes/cluster.html" class="sidebar-link">Cluster</a></li><li><a href="/dev-tools/kubernetes/dev-env.html" class="sidebar-link">Dev Environment</a></li><li><a href="/dev-tools/kubernetes/api.html" class="sidebar-link">Kubernetes API</a></li><li><a href="/dev-tools/kubernetes/objects.html" class="sidebar-link">Objects</a></li><li><a href="/dev-tools/kubernetes/pods.html" class="sidebar-link">Pods</a></li><li><a href="/dev-tools/kubernetes/deployments.html" class="sidebar-link">Deployments</a></li><li><a href="/dev-tools/kubernetes/services.html" aria-current="page" class="active sidebar-link">Services</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev-tools/kubernetes/services.html#dns" class="sidebar-link">DNS</a></li><li class="sidebar-sub-header"><a href="/dev-tools/kubernetes/services.html#binding-services-to-pods" class="sidebar-link">Binding services to pods</a></li><li class="sidebar-sub-header"><a href="/dev-tools/kubernetes/services.html#services-types" class="sidebar-link">Services types</a></li><li class="sidebar-sub-header"><a href="/dev-tools/kubernetes/services.html#endpoints" class="sidebar-link">Endpoints</a></li><li class="sidebar-sub-header"><a href="/dev-tools/kubernetes/services.html#headless-services" class="sidebar-link">Headless Services</a></li><li class="sidebar-sub-header"><a href="/dev-tools/kubernetes/services.html#tips" class="sidebar-link">Tips</a></li></ul></li><li><a href="/dev-tools/kubernetes/events.html" class="sidebar-link">Events</a></li><li><a href="/dev-tools/kubernetes/storage.html" class="sidebar-link">Storage</a></li><li><a href="/dev-tools/kubernetes/configuration.html" class="sidebar-link">Configuration</a></li><li><a href="/dev-tools/kubernetes/organization.html" class="sidebar-link">Organizing Objects</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Ansible</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Azure</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content"><div class="content__default"><h1 id="services"><a href="#services" class="header-anchor">#</a> Services</h1> <p>Pods can communicate with each other using private IP address space. They can be
on different nodes, but K8s handles appropriate routing. For a pod, all other
pods are on the same LAN.</p> <p><img src="assets/pods-network-flat.png" alt=""></p> <p>Problems:</p> <ul><li>Pods are ephemeral and their IP might suddenly change.</li> <li>Pods are not accessible on the outside by default.</li></ul> <p>Services enable a single communication entry point to the pods. There'll be a
single IP address regardless of how many replicas are deployed.</p> <p>Service's IP never changes, it's static, unlike the IPs of pods (pods die, and
new ones get created).</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Services make the pods accessible at one static entry point (IP), no matter how
many replicas there are.</p> <p><img src="/assets/img/k8s-service.f2c49956.png" alt=""></p></div> <p>Services operate at the Layer 4 of the <a href="/networking/osi-model.html">OSI model</a>.
They do not understand URLs, cookies (e.g. cookie-based affinity is not
supported, only IP-based is supported), etc.</p> <p>Creating a simple service: <code>kubectl expose deployment kiada --type=LoadBalancer --port 8080</code>. It exposes all pods in the &quot;kiada&quot; deployment as a new service.
The pods will be accessible via a load balancer. Service name is inherited from
the deployment since we didn't specify any name.</p> <h2 id="dns"><a href="#dns" class="header-anchor">#</a> DNS</h2> <p>K8s runs pods with DNS servers (and a service to expose them as ClusterIP!),
which all pods are configured to use. Thanks to them, service's IP is resolvable
by service's name. If a service resides in a different namespace than the client
pod, the namespace must be appended to the URL. Examples:</p> <ul><li><code>http://quiz</code> - when the <code>quiz</code> service is in the same ns</li> <li><code>http://quiz.kiada</code> - when the <code>quiz</code> service is in another namespace (called
<code>kiada</code>)</li></ul> <div class="custom-block tip"><p class="custom-block-title">Other URLs</p> <p>Services are resolvable with:</p> <ul><li><code>&lt;service-name&gt;</code> - same NS</li> <li><code>&lt;service-name&gt;&lt;service-ns&gt;</code> - different NS</li> <li><code>&lt;service-name&gt;.&lt;service-namespace&gt;.svc</code></li> <li><code>&lt;service-name&gt;.&lt;service-namespace&gt;.svc.cluster.local</code> - the <code>cluster.local</code>
suffix might be changed at the cluster level.</li></ul></div> <p>The IP addresses of services in a namespace are also available as envs in all
pods (the pod needs to be started after the service is created!). It's better to
rely on DNS though. These envs may be disabled with <code>enableServiceLinks</code> on a
pod.</p> <h2 id="binding-services-to-pods"><a href="#binding-services-to-pods" class="header-anchor">#</a> Binding services to pods</h2> <p>Services use <strong>label selectors</strong> to find pods that belong to a Service.</p> <p><img src="/assets/img/service-binding-to-pods.b2cb138e.png" alt=""></p> <h2 id="services-types"><a href="#services-types" class="header-anchor">#</a> Services types</h2> <p>K8s supports the following Service types:</p> <ul><li><strong>ClusterIP</strong> - only within the cluster (it's the <strong>default</strong>). It acts as a
load balancer when multiple pods are behind it.</li> <li><strong>NodePort</strong> - a port on all nodes takes us to the pod. It is accessible from
the outside via any node's IP. Node ports may be explicitly specified in the
manifest or K8s may assign them randomly.</li> <li><strong>LoadBalancer</strong> - depends on cloud provider. There is an external load
balancer in front of the nodes that routes the traffic to the nodes. It is an
extension of NodePort. The pods will be accessible via a new IP address
belonging to the load balancer.</li></ul> <p><img src="/assets/img/load-balancer-service.8775594d.png" alt=""></p> <ul><li><strong>ExternalName</strong> - creates CNAME records in K8s DNS. They have no clusterIP.
The client gets the IP of the CNAMEd service.</li></ul> <h3 id="load-balancer"><a href="#load-balancer" class="header-anchor">#</a> Load Balancer</h3> <p>Kuberneets allows to create a service of LoadBalancer type, but it does not
provide load balancing itself. It asks the cloud infrastucture to provide it.
The IP address of the load balancer becomes an External IP of the service.</p> <p><img src="https://i.imgur.com/ClDDOJ7.png" alt=""></p> <p>Using Minikube or kind, the external IP will always be <code>&lt;Pending&gt;</code>, because load
balancing functionality does not exist (it can be installed though, for example
with MetalLB). We can access the service via any worker node IP with a port of
the service:</p> <p><img src="https://i.imgur.com/TFPxmnh.png" alt=""></p> <p>These node ports are what the load balancer forwards the traffic to:</p> <p><img src="https://i.imgur.com/xp9CneN.png" alt=""></p> <p>There are actually two load balancers:</p> <ul><li>cloud-provider one that load balances traffic between nodes</li> <li>K8s one that load balances traffic between pods</li></ul> <p>With such a setup, every request has added latency, there're a lot of hops (load
balancer -&gt; node -&gt; potentially another node if first one didn't have a pod -&gt;
pod).
Additionally, original client's IP is lost due to these hops.</p> <h2 id="endpoints"><a href="#endpoints" class="header-anchor">#</a> Endpoints</h2> <p>Together with a Service, and <strong>Endpoints</strong> object is created. Its name matches
that of the Service. It contains a list of {IP}:{PORT} that a given service
leads to together with other metadata (which node, which pod). It is built based on selectors specified for a service.</p> <p>There are also <strong>EndpointSlices</strong> objects, which are created by K8s when the
number of endpoints of a service is large. Sending around a huge Endpoints
object in a cluster becomes a performance issue. One Endpoints object may be
splitted into multiple EndpointSlices.
These two types of objects exist at the same time (why?).</p> <p>These objects are fully managed by K8s, it automatically updates
Endpoints/EndpointSlices as pods are created/deleted - only if a service has a
label selector! If it doesn't, we need to create Endpoints objects by ourselves.
We don't need to create EndpointSlices, K8s will do that for us based on
Endpoints object. It's useful when we want to expose some external service via a
Service to the pods with an internal DNS name. We could, for example, switch
from some K8s-hosted service to an external one (e.g. a DB) and just by removing
a selector from a Service and creating Endpoints object that would work. The
pods wouldn't notice any difference. We could also do the opposite.</p> <p>Availability of a given pod in Endpoints object depends from the status of the
<a href="/dev-tools/kubernetes/pods.html#readiness-probe">readiness probe</a> of that pod. If it's not ready,
it'll be moved to <code>notReadyAddresses</code> in the Endpoints object. Readiness of pods
may also be ignored by Services with proper configuration. Additionally, K8s
automatically removes pods that are being shut down from Endpoints.</p> <h2 id="headless-services"><a href="#headless-services" class="header-anchor">#</a> Headless Services</h2> <p>We can skip the Service hop (pod -&gt; Service -&gt; pod) by creating headless
service. When a DNS name of such a service gets resolved, instead of returning
service's IP, the IPs of endpoints behind it are returned.</p> <p>It enables scenarios such as:</p> <ul><li>load balancing from the client side</li> <li>ability to contact all pods of a given service</li></ul> <p>If a pod does not need to know IP addresses of all the pods and it just wants to
use the service as normal, it can. The DNS will randomly return any pod's IP and
the client will talk directly to a pod. DNS-aware clients can make use of the
advantages listed above though.</p> <p><img src="/assets/img/headless-services.b4b88733.png" alt=""></p> <p>Headless services are created by placing <code>clusterIP: None</code> in the YAML definition.</p> <h2 id="tips"><a href="#tips" class="header-anchor">#</a> Tips</h2> <ul><li>Services cannot be pinged</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/marcinjahn/knowledge-website/edit/main/src/docs/dev-tools/kubernetes/services.md" target="_blank" rel="noopener noreferrer">Feel free to contribute to this article!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/21/2021, 10:30:33 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dev-tools/kubernetes/deployments.html" class="prev">
        Deployments
      </a></span> <span class="next"><a href="/dev-tools/kubernetes/events.html">
        Events
      </a>
      →
    </span></p></div></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.87cbde57.js" defer></script><script src="/assets/js/2.f59378ff.js" defer></script><script src="/assets/js/4.e66cdc67.js" defer></script>
  </body>
</html>
