<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Smart Pointers | Marcin Jahn | Technology Notebook</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-ZSM2N36X8P"></script>
    <script>(function() { if (window.location.href.startsWith('http://localhost')) { return; } window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-ZSM2N36X8P'); })();</script>
    <meta name="description" content="Smart Pointers in Rust">
    <meta property="og:url" content="/programming/rust/smart-pointers.html">
    <meta property="og:site_name" content="Marcin Jahn | Technology Notebook">
    <meta property="og:title" content="Smart Pointers">
    <meta property="og:description" content="Smart Pointers in Rust">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="Marcin Jahn | Technology Notebook">
    <meta property="article:author" content="Marcin Jahn">
    <meta name="theme-color" content="white">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.efb9a866.css" as="style"><link rel="preload" href="/assets/js/app.b3518e24.js" as="script"><link rel="preload" href="/assets/js/2.189ac7f1.js" as="script"><link rel="preload" href="/assets/js/9.ed2aed21.js" as="script"><link rel="prefetch" href="/assets/js/10.80e56dd6.js"><link rel="prefetch" href="/assets/js/100.f3d63f9f.js"><link rel="prefetch" href="/assets/js/101.6b67120d.js"><link rel="prefetch" href="/assets/js/102.48520b6b.js"><link rel="prefetch" href="/assets/js/103.8ba159c6.js"><link rel="prefetch" href="/assets/js/104.e9714af4.js"><link rel="prefetch" href="/assets/js/105.371cfa0d.js"><link rel="prefetch" href="/assets/js/106.8e06b411.js"><link rel="prefetch" href="/assets/js/107.78ba4e6e.js"><link rel="prefetch" href="/assets/js/108.35ec6d13.js"><link rel="prefetch" href="/assets/js/109.153fb5b0.js"><link rel="prefetch" href="/assets/js/11.9bab91bf.js"><link rel="prefetch" href="/assets/js/110.beebfe2a.js"><link rel="prefetch" href="/assets/js/111.ed95631e.js"><link rel="prefetch" href="/assets/js/112.91f42c95.js"><link rel="prefetch" href="/assets/js/12.bb43136e.js"><link rel="prefetch" href="/assets/js/13.fce6930a.js"><link rel="prefetch" href="/assets/js/14.8771443b.js"><link rel="prefetch" href="/assets/js/15.71f025fe.js"><link rel="prefetch" href="/assets/js/16.36586f7d.js"><link rel="prefetch" href="/assets/js/17.78b11971.js"><link rel="prefetch" href="/assets/js/18.0a72fa34.js"><link rel="prefetch" href="/assets/js/19.a828f8f0.js"><link rel="prefetch" href="/assets/js/20.8b337bc5.js"><link rel="prefetch" href="/assets/js/21.9cce8f71.js"><link rel="prefetch" href="/assets/js/22.f3cab438.js"><link rel="prefetch" href="/assets/js/23.61ecf82e.js"><link rel="prefetch" href="/assets/js/24.2e55a16a.js"><link rel="prefetch" href="/assets/js/25.73b70442.js"><link rel="prefetch" href="/assets/js/26.bd6ce2b6.js"><link rel="prefetch" href="/assets/js/27.b57ac51b.js"><link rel="prefetch" href="/assets/js/28.8e277212.js"><link rel="prefetch" href="/assets/js/29.38e71723.js"><link rel="prefetch" href="/assets/js/3.c43547e4.js"><link rel="prefetch" href="/assets/js/30.8c5df7de.js"><link rel="prefetch" href="/assets/js/31.33b78734.js"><link rel="prefetch" href="/assets/js/32.48351acc.js"><link rel="prefetch" href="/assets/js/33.57fd471e.js"><link rel="prefetch" href="/assets/js/34.43b7839b.js"><link rel="prefetch" href="/assets/js/35.b7503fab.js"><link rel="prefetch" href="/assets/js/36.5ed00cce.js"><link rel="prefetch" href="/assets/js/37.598066ce.js"><link rel="prefetch" href="/assets/js/38.83db00b0.js"><link rel="prefetch" href="/assets/js/39.af1fe7dd.js"><link rel="prefetch" href="/assets/js/4.6f0793b7.js"><link rel="prefetch" href="/assets/js/40.62f1475a.js"><link rel="prefetch" href="/assets/js/41.68fcc2e0.js"><link rel="prefetch" href="/assets/js/42.d4bff1bc.js"><link rel="prefetch" href="/assets/js/43.b99ae171.js"><link rel="prefetch" href="/assets/js/44.2cd8e765.js"><link rel="prefetch" href="/assets/js/45.597a5b45.js"><link rel="prefetch" href="/assets/js/46.5d4d7a72.js"><link rel="prefetch" href="/assets/js/47.182b03bf.js"><link rel="prefetch" href="/assets/js/48.b0d5f809.js"><link rel="prefetch" href="/assets/js/49.af997b34.js"><link rel="prefetch" href="/assets/js/5.caef7847.js"><link rel="prefetch" href="/assets/js/50.b69c3b1b.js"><link rel="prefetch" href="/assets/js/51.4c2e9161.js"><link rel="prefetch" href="/assets/js/52.7974a145.js"><link rel="prefetch" href="/assets/js/53.33c85916.js"><link rel="prefetch" href="/assets/js/54.bccc2fd3.js"><link rel="prefetch" href="/assets/js/55.72a0d5d3.js"><link rel="prefetch" href="/assets/js/56.b789463a.js"><link rel="prefetch" href="/assets/js/57.22d661b1.js"><link rel="prefetch" href="/assets/js/58.d813e503.js"><link rel="prefetch" href="/assets/js/59.0450d662.js"><link rel="prefetch" href="/assets/js/6.fd6a23a8.js"><link rel="prefetch" href="/assets/js/60.95437a9b.js"><link rel="prefetch" href="/assets/js/61.8b639911.js"><link rel="prefetch" href="/assets/js/62.1cbebb17.js"><link rel="prefetch" href="/assets/js/63.a4c0ee6d.js"><link rel="prefetch" href="/assets/js/64.e95e02b3.js"><link rel="prefetch" href="/assets/js/65.594aa04d.js"><link rel="prefetch" href="/assets/js/66.60f55c5d.js"><link rel="prefetch" href="/assets/js/67.8a8c0543.js"><link rel="prefetch" href="/assets/js/68.a6de9f21.js"><link rel="prefetch" href="/assets/js/69.4731e17d.js"><link rel="prefetch" href="/assets/js/7.fcef78e7.js"><link rel="prefetch" href="/assets/js/70.df3d0508.js"><link rel="prefetch" href="/assets/js/71.2f589476.js"><link rel="prefetch" href="/assets/js/72.f27c5929.js"><link rel="prefetch" href="/assets/js/73.f7f0bb9a.js"><link rel="prefetch" href="/assets/js/74.bc76b340.js"><link rel="prefetch" href="/assets/js/75.c273c06a.js"><link rel="prefetch" href="/assets/js/76.abbfd72e.js"><link rel="prefetch" href="/assets/js/77.3cbdac60.js"><link rel="prefetch" href="/assets/js/78.cac2b5c2.js"><link rel="prefetch" href="/assets/js/79.13909cbf.js"><link rel="prefetch" href="/assets/js/8.11927cb9.js"><link rel="prefetch" href="/assets/js/80.66c4ff89.js"><link rel="prefetch" href="/assets/js/81.6052ce2b.js"><link rel="prefetch" href="/assets/js/82.b2bd66be.js"><link rel="prefetch" href="/assets/js/83.cab22e53.js"><link rel="prefetch" href="/assets/js/84.53cfb86b.js"><link rel="prefetch" href="/assets/js/85.c3f64177.js"><link rel="prefetch" href="/assets/js/86.eb0d3a66.js"><link rel="prefetch" href="/assets/js/87.4e609be7.js"><link rel="prefetch" href="/assets/js/88.4918f5f5.js"><link rel="prefetch" href="/assets/js/89.1f43f314.js"><link rel="prefetch" href="/assets/js/90.8d1a97bb.js"><link rel="prefetch" href="/assets/js/91.615963fa.js"><link rel="prefetch" href="/assets/js/92.794cf15e.js"><link rel="prefetch" href="/assets/js/93.71744d28.js"><link rel="prefetch" href="/assets/js/94.ce87d362.js"><link rel="prefetch" href="/assets/js/95.7da57503.js"><link rel="prefetch" href="/assets/js/96.7654846d.js"><link rel="prefetch" href="/assets/js/97.01bc56a3.js"><link rel="prefetch" href="/assets/js/98.436765b0.js"><link rel="prefetch" href="/assets/js/99.62928d86.js">
    <link rel="stylesheet" href="/assets/css/0.styles.efb9a866.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar boxshadow"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Marcin Jahn | Technology Notebook</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/programming/" class="nav-link router-link-active">
  Programming
</a></div><div class="nav-item"><a href="/dev-tools/" class="nav-link">
  Tools and Infrastructure
</a></div><div class="nav-item"><a href="/technologies/" class="nav-link">
  Technologies
</a></div><div class="nav-item"><a href="/projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="/meta/" class="nav-link">
  Meta
</a></div> <span class="external-services" data-v-6c2342f8><a target="_blank" href="https://www.linkedin.com/in/marcin-jahn-63a9b915b/?locale=en_US" data-v-f9b87572 data-v-6c2342f8><img src="/img/linkedin.webp" data-v-f9b87572></a><a target="_blank" href="https://github.com/marcinjahn" data-v-f9b87572 data-v-6c2342f8><img src="/img/github.webp" data-v-f9b87572></a></span> <a href="https://github.com/marcinjahn/technology-notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    Code on GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/programming/" class="nav-link router-link-active">
  Programming
</a></div><div class="nav-item"><a href="/dev-tools/" class="nav-link">
  Tools and Infrastructure
</a></div><div class="nav-item"><a href="/technologies/" class="nav-link">
  Technologies
</a></div><div class="nav-item"><a href="/projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="/meta/" class="nav-link">
  Meta
</a></div> <span class="external-services" data-v-6c2342f8><a target="_blank" href="https://www.linkedin.com/in/marcin-jahn-63a9b915b/?locale=en_US" data-v-f9b87572 data-v-6c2342f8><img src="/img/linkedin.webp" data-v-f9b87572></a><a target="_blank" href="https://github.com/marcinjahn" data-v-f9b87572 data-v-6c2342f8><img src="/img/github.webp" data-v-f9b87572></a></span> <a href="https://github.com/marcinjahn/technology-notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    Code on GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/programming/" aria-current="page" class="sidebar-link">/programming/</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>.NET</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Rust</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/programming/rust/overview.html" class="sidebar-link">Overview</a></li><li><a href="/programming/rust/cargo.html" class="sidebar-link">Cargo</a></li><li><a href="/programming/rust/basics.html" class="sidebar-link">Basics</a></li><li><a href="/programming/rust/ownership.html" class="sidebar-link">Ownership</a></li><li><a href="/programming/rust/structs.html" class="sidebar-link">Structures</a></li><li><a href="/programming/rust/enums.html" class="sidebar-link">Enums</a></li><li><a href="/programming/rust/organization.html" class="sidebar-link">Organization</a></li><li><a href="/programming/rust/collections.html" class="sidebar-link">Collections</a></li><li><a href="/programming/rust/error-handling.html" class="sidebar-link">Error Handling</a></li><li><a href="/programming/rust/generics.html" class="sidebar-link">Generics</a></li><li><a href="/programming/rust/traits.html" class="sidebar-link">Traits</a></li><li><a href="/programming/rust/lifetimes.html" class="sidebar-link">Lifetimes</a></li><li><a href="/programming/rust/closures.html" class="sidebar-link">Closures</a></li><li><a href="/programming/rust/pointers.html" class="sidebar-link">Raw Pointers</a></li><li><a href="/programming/rust/smart-pointers.html" aria-current="page" class="active sidebar-link">Smart Pointers</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/programming/rust/smart-pointers.html#traits" class="sidebar-link">Traits</a></li><li class="sidebar-sub-header"><a href="/programming/rust/smart-pointers.html#box" class="sidebar-link">Box</a></li><li class="sidebar-sub-header"><a href="/programming/rust/smart-pointers.html#rc" class="sidebar-link">Rc</a></li><li class="sidebar-sub-header"><a href="/programming/rust/smart-pointers.html#refcel" class="sidebar-link">RefCel</a></li></ul></li><li><a href="/programming/rust/concurrency.html" class="sidebar-link">Concurrency</a></li><li><a href="/programming/rust/testing.html" class="sidebar-link">Testing</a></li><li><a href="/programming/rust/tips.html" class="sidebar-link">Tips</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>C/C++</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Algorithms</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content"><div class="content__default"><h1 id="smart-pointers"><a href="#smart-pointers" class="header-anchor">#</a> Smart Pointers</h1> <p>The most common kind of pointer in Rust is a <strong>reference</strong>. <strong>Smart Pointers</strong>
not only act like pointers but also have additional metadata and capabilities,
like reference counting. There are a few types of smart pointers in Rust.</p> <p>References borrow data, while smart pointers often own the data.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>String</code> and <code>Vec&lt;T&gt;</code> are smart pointers! They own some memory and can
manipulate it. They have metadata (like capacity).</p></div> <p>There are some built-in smart pointers add there are many in crates. We can
write our smart pointers as well.</p> <h2 id="traits"><a href="#traits" class="header-anchor">#</a> Traits</h2> <p>Smart pointers are usually structs. They implement <code>Deref</code> and <code>Drop</code> traits.</p> <h3 id="deref"><a href="#deref" class="header-anchor">#</a> Deref</h3> <p><code>Deref</code> allows an instance of a struct to behave like a reference, so consuming
code can work either with references or smart pointers. It does it by allowing
customizing the behavior of the <em>dereference operator</em> (<code>*</code>).</p> <p>Here's an example of how dereferencing may be used with smart pointers, same as
with <a href="/programming/rust/ownership.html#dereferencing">references</a>:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// compiler calls *(y.deref()) behind the scenes</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Deref</code> trait has one method - <code>deref()</code> - it should return a <code>&amp;</code>
(immutable) reference. By using <code>*</code>, compiler calls <code>deref()</code> behind the
scenes to get a reference, and then it knows how to get value behind that
reference.</p> <h4 id="deref-coersion"><a href="#deref-coersion" class="header-anchor">#</a> Deref Coersion</h4> <p>Rust can automatically dereference values to proper types if possible. For
example, if a function expects <code>&amp;str</code> we can pass it <code>&amp;String</code>. The compiler
will call <code>defer()</code> on the <code>&amp;String</code> to get <code>&amp;str</code>. Compiler can call <code>deref()</code>
as many times as needed until the proper type is found. E.g., if we had
<code>Box&lt;String&gt;</code> it would have to call <code>deref()</code> twice:</p> <blockquote><p><code>&amp;Box&lt;String&gt;</code> -&gt; <code>&amp;String</code> -&gt; <code>&amp;str</code></p></blockquote> <div class="custom-block tip"><p class="custom-block-title">DerefMut</p> <p>Similar to <code>Deref</code> is the <code>DerefMut</code> trait. It enables resolving of mutable
references <code>mut&amp;</code>.</p></div> <h3 id="drop"><a href="#drop" class="header-anchor">#</a> Drop</h3> <p><code>Drop</code> allows writing code that will be run when the a type goes out of scope.
E.g. it could release some resources like files or connections. It is similar to
<code>IDisposable</code> interface in the .NET world. In the case of smart pointers, <code>Drop</code>
will deallocate the memory on the heap.</p> <p>The <code>Drop</code> trait has one method - <code>drop()</code>. Compiler will call it automatically
when the value goes out of scope.</p> <div class="custom-block tip"><p class="custom-block-title">Dropping manually</p> <p>If we need to destruct an instance before its end of scope, we can call
<code>drop(instance)</code>. It's not the same <code>drop()</code> as the one implemented via the
<code>Drop</code> trait! Calling that one explicitly is not allowed.</p></div> <h2 id="box"><a href="#box" class="header-anchor">#</a> Box</h2> <p>It's the most straightforward smart pointer. It allows storing data on the
heap instead of the stack. Only the pointer stays on the stack.</p> <h3 id="storing-data-on-the-heap"><a href="#storing-data-on-the-heap" class="header-anchor">#</a> Storing Data on the Heap</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5 is on the heap</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;b = {}&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>When <code>b</code> goes out of scope, both the <code>Box</code> and <code>i32</code> it points to get
deallocated.</p> <h3 id="recursive-types"><a href="#recursive-types" class="header-anchor">#</a> Recursive Types</h3> <p>Data on the stack needs to be of a known size. Not all values are. Recursive
types can infinitely contain other values of the same type - they are of unknown
size. They should be stored on the heap.</p> <p>Example:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">enum</span> <span class="token type-definition class-name">List</span> <span class="token punctuation">{</span>
  <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">Nil</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This enum does not compile; its size is unknown.</p> <p><img src="/assets/img/inifinite-struct-size.8a4fecf5.png" alt=""></p> <p>Here's a version with a <code>Box&lt;T&gt;</code>:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">enum</span> <span class="token type-definition class-name">List</span> <span class="token punctuation">{</span>
  <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">Nil</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Only the <code>i32</code> 1 and the first <code>Box&lt;T&gt;</code> are stored on the stack. The rest is on
the heap:</p> <p><img src="/assets/img/struct-of-known-size.da2e858c.png" alt=""></p> <h2 id="rc"><a href="#rc" class="header-anchor">#</a> Rc</h2> <p>The <code>Rc&lt;T&gt;</code> smart pointer enables multiple ownership - owning a value by
multiple bindings. <em>Rc</em> stands for <em>reference counting</em>. <code>Rc&lt;T&gt;</code> keeps track of
the number of references to a value. If there are none, the value can be cleaned
up safely. <code>Rc&lt;T&gt;</code> is useful when multiple actors in our program will read the
data, but we don't know which one will be the last to do that. Otherwise, we
could use the &quot;normal&quot; ownership concepts. <code>Rc</code> allows to have multiple
<strong>immutable references</strong>. Mutable references would bring chaos.</p> <div class="custom-block danger"><p class="custom-block-title">Multi-threading</p> <p><code>Rc&lt;T&gt;</code> is only for single-threaded scenarios!</p></div> <div class="custom-block tip"><p class="custom-block-title">Graphs</p> <p><code>Rc&lt;T&gt;</code> is useful in graph-like structures where nodes may be pointed at by
multiple other nodes.</p></div> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">enum</span> <span class="token type-definition class-name">List</span> <span class="token punctuation">{</span>
  <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">Nil</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">List</span><span class="token punctuation">::</span><span class="token punctuation">{</span><span class="token class-name">Cons</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>]<img src="/assets/img/graph-with-rc.db26ad4c.png" alt=""></p> <p>There are 3 references to <code>a</code>, all of them encapsulated within <code>Rc</code>.
The value will &quot;live&quot; as long as any <code>Rc</code> instance still points to it.</p> <div class="custom-block tip"><p class="custom-block-title">Performance</p> <p><code>clone()</code> on <code>Rc</code> is cheap. It just increments reference count. It's cheaper to
clone <code>Rc</code> than to clone the actual value that <code>Rc</code> points to.</p></div> <div class="custom-block tip"><p class="custom-block-title">Check count</p> <p>We can check the current reference count of <code>Rc</code> with <code>Rc::strong_count(&amp;a)</code>,
where <code>&amp;a</code> is a reference to an actual instance of <code>Rc</code>.</p></div> <h3 id="weak"><a href="#weak" class="header-anchor">#</a> Weak</h3> <p><code>Rc</code> allows to create two types of smart pointers:</p> <ul><li><code>Rc::clone(&amp;a)</code> - strong reference (<code>Rc&lt;T&gt;</code>)</li> <li><code>Rc::downgrade(&amp;a)</code> - weak reference (<code>Weak&lt;T&gt;</code>)</li></ul> <p>Weak references do not increment the <code>strong_count</code>, they increment
<code>weak_count</code>. The <code>weak_count</code> does not need to be 0 for the value being
referred to to be dropped.</p> <p>Since the value begind <code>Weak&lt;T&gt;</code> is uncertain it needs to be retrieved using
the <code>upgrade()</code> method that returns <code>Option&lt;T&gt;</code>.</p> <div class="custom-block tip"><p class="custom-block-title">Reference Cycles</p> <p><code>Weak</code> is useful for protection agains reference cycles. If some node referes to
another via <code>Rc</code>, it's a strong connection. If the other node needs to have a
reference to the first one as well, it would use <code>Weak</code>. That way, the
<code>strong_count</code> stays at 1 and the nodes can be dropped when they go out of
scope.</p> <p><code>Weak</code> is useful in graphs as an alternative of <code>Rc</code>.</p></div> <h2 id="refcel"><a href="#refcel" class="header-anchor">#</a> RefCel</h2> <p>Here are the borrowing rules in Rust:</p> <ul><li>At any given time, you can have either (but not both of) one mutable reference
or any number of immutable references.</li> <li>References must always be valid.</li></ul> <p>With references and <code>Box&lt;T&gt;</code>, the borrowing rules are enforced at compile time.
With <code>RefCell&lt;T&gt;</code>, these invariants are enforced at runtime. With references, if
you break these rules, you’ll get a compiler error. With <code>RefCell&lt;T&gt;,</code> if you
break these rules, your program will panic and exit.</p> <div class="custom-block tip"><p class="custom-block-title">Why?</p> <p>The <code>RefCell&lt;T&gt;</code> type is useful when you’re sure your code follows the borrowing
rules but the compiler is unable to understand and guarantee that.</p></div> <div class="custom-block danger"><p class="custom-block-title">Multi-threading</p> <p><code>Rc&lt;T&gt;</code> is only for single-threaded scenarios!</p></div> <p>Because <code>RefCell&lt;T&gt;</code> allows mutable borrows checked at runtime, you can mutate
the value inside the <code>RefCell&lt;T&gt;</code> even when the <code>RefCell&lt;T&gt;</code> is immutable. This
is <strong>interior mutability</strong> pattern.</p> <blockquote><p><strong>Interior mutability</strong> is a design pattern in Rust that allows you to mutate
data even when there are immutable references to that data. Normally, it's
disallowed by borrowing rules.</p></blockquote> <p>Here's an example of practical usage of <code>RefCell</code>:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">MockMessenger</span> <span class="token punctuation">{</span>
  sent_messages<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
  <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
    <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
      sent_messages<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Messenger</span> <span class="token keyword">for</span> <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
  <span class="token keyword">fn</span> <span class="token function-definition function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>sent_messages<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>send()</code> message has an immutable reference to <code>self</code>, because it makes
sense from the client perspective of that method. Normally, sending data should
not modify the state of the sender object. However, our implementation is some
mock that is supposed to keep every call to <code>send()</code> for verification later on.
<code>RefCell</code> comes into the picture. We can use it as a pointer to a <code>Vec</code> that
stores the invocations. We can get a mutable reference to that vector with
<code>borrow_mut()</code>.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>RefCell</code> also allows to get an immutable reference using <code>borrow()</code>.</p></div> <p><code>RefCell</code> keeps track of how many mutable and immutable references were taken
out of it. <code>RefCell</code>, following the borrowing rules still allows multiple
immutable references or only one mutable reference at a time! Breaking these
rules results in a panic (at runtime).</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>We can combine the capabilities of <code>Rc</code> and <code>RefCell</code> to be able to get
<strong>multiple owners</strong> of <strong>mutable</strong> data. An example is
<a href="https://doc.rust-lang.org/book/ch15-05-interior-mutability.html#having-multiple-owners-of-mutable-data-by-combining-rct-and-refcellt" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div></div> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/programming/rust/pointers.html" class="prev">
        Raw Pointers
      </a></span> <span class="next"><a href="/programming/rust/concurrency.html">
        Concurrency
      </a>
      →
    </span></p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/7/2022, 8:33:51 AM</span></div></footer> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b3518e24.js" defer></script><script src="/assets/js/2.189ac7f1.js" defer></script><script src="/assets/js/9.ed2aed21.js" defer></script>
  </body>
</html>
