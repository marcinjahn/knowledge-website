<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Overview | Marcin Jahn | Technology Notebook</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-ZSM2N36X8P"></script>
    <script>(function() { if (window.location.href.startsWith('http://localhost')) { return; } window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-ZSM2N36X8P'); })();</script>
    <meta name="description" content="Overview of Entity Framework Core">
    <meta property="og:url" content="/programming/dotnet/entity-framework-core/">
    <meta property="og:site_name" content="Marcin Jahn | Technology Notebook">
    <meta property="og:title" content="Overview">
    <meta property="og:description" content="Overview of Entity Framework Core">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="Marcin Jahn | Technology Notebook">
    <meta property="article:author" content="Marcin Jahn">
    <meta name="theme-color" content="white">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.d0479855.css" as="style"><link rel="preload" href="/assets/js/app.a0878009.js" as="script"><link rel="preload" href="/assets/js/2.a608218f.js" as="script"><link rel="preload" href="/assets/js/72.62b896d4.js" as="script"><link rel="prefetch" href="/assets/js/10.955e5d43.js"><link rel="prefetch" href="/assets/js/100.c344fd03.js"><link rel="prefetch" href="/assets/js/101.e926ab2f.js"><link rel="prefetch" href="/assets/js/102.33613b7d.js"><link rel="prefetch" href="/assets/js/103.ae983361.js"><link rel="prefetch" href="/assets/js/104.74bbfc0e.js"><link rel="prefetch" href="/assets/js/105.93138e4e.js"><link rel="prefetch" href="/assets/js/106.96bf7371.js"><link rel="prefetch" href="/assets/js/107.0c6bda7b.js"><link rel="prefetch" href="/assets/js/108.af70a697.js"><link rel="prefetch" href="/assets/js/109.d72e9255.js"><link rel="prefetch" href="/assets/js/11.e82950e4.js"><link rel="prefetch" href="/assets/js/110.577bec38.js"><link rel="prefetch" href="/assets/js/111.37462b9d.js"><link rel="prefetch" href="/assets/js/112.8cdef052.js"><link rel="prefetch" href="/assets/js/113.65a4d6bf.js"><link rel="prefetch" href="/assets/js/114.d9b0d8bd.js"><link rel="prefetch" href="/assets/js/115.51a36652.js"><link rel="prefetch" href="/assets/js/116.615da026.js"><link rel="prefetch" href="/assets/js/117.396fa3bd.js"><link rel="prefetch" href="/assets/js/118.60f7a0e9.js"><link rel="prefetch" href="/assets/js/119.f294d40a.js"><link rel="prefetch" href="/assets/js/12.f0db8451.js"><link rel="prefetch" href="/assets/js/120.d2d702df.js"><link rel="prefetch" href="/assets/js/121.085672d6.js"><link rel="prefetch" href="/assets/js/122.d8ab0e1c.js"><link rel="prefetch" href="/assets/js/123.672e9dc6.js"><link rel="prefetch" href="/assets/js/124.0b51aaa3.js"><link rel="prefetch" href="/assets/js/125.05a089dc.js"><link rel="prefetch" href="/assets/js/126.7982b6d5.js"><link rel="prefetch" href="/assets/js/13.2d4d2efb.js"><link rel="prefetch" href="/assets/js/14.d943a84a.js"><link rel="prefetch" href="/assets/js/15.9ec0ba77.js"><link rel="prefetch" href="/assets/js/16.bb1a857f.js"><link rel="prefetch" href="/assets/js/17.2329054e.js"><link rel="prefetch" href="/assets/js/18.70bcada4.js"><link rel="prefetch" href="/assets/js/19.bcc3273d.js"><link rel="prefetch" href="/assets/js/20.7f3bf752.js"><link rel="prefetch" href="/assets/js/21.645b7f8e.js"><link rel="prefetch" href="/assets/js/22.b24eba90.js"><link rel="prefetch" href="/assets/js/23.dacd29a4.js"><link rel="prefetch" href="/assets/js/24.61a7a272.js"><link rel="prefetch" href="/assets/js/25.70ffc5d2.js"><link rel="prefetch" href="/assets/js/26.d5b48f5b.js"><link rel="prefetch" href="/assets/js/27.a89bab68.js"><link rel="prefetch" href="/assets/js/28.9db5cfb4.js"><link rel="prefetch" href="/assets/js/29.8debde2d.js"><link rel="prefetch" href="/assets/js/3.f58aa2db.js"><link rel="prefetch" href="/assets/js/30.faf769c9.js"><link rel="prefetch" href="/assets/js/31.125000da.js"><link rel="prefetch" href="/assets/js/32.fa41c4aa.js"><link rel="prefetch" href="/assets/js/33.7487efab.js"><link rel="prefetch" href="/assets/js/34.4974810c.js"><link rel="prefetch" href="/assets/js/35.6ec22e4e.js"><link rel="prefetch" href="/assets/js/36.85149ed9.js"><link rel="prefetch" href="/assets/js/37.d97ebc15.js"><link rel="prefetch" href="/assets/js/38.8bea259f.js"><link rel="prefetch" href="/assets/js/39.5b2f295f.js"><link rel="prefetch" href="/assets/js/4.9de7b95b.js"><link rel="prefetch" href="/assets/js/40.542639da.js"><link rel="prefetch" href="/assets/js/41.a0931265.js"><link rel="prefetch" href="/assets/js/42.66fd13b1.js"><link rel="prefetch" href="/assets/js/43.93e70475.js"><link rel="prefetch" href="/assets/js/44.b3f2bc5d.js"><link rel="prefetch" href="/assets/js/45.4cae8bc2.js"><link rel="prefetch" href="/assets/js/46.1023f77f.js"><link rel="prefetch" href="/assets/js/47.d0ec145f.js"><link rel="prefetch" href="/assets/js/48.49d7d26c.js"><link rel="prefetch" href="/assets/js/49.caa29e2b.js"><link rel="prefetch" href="/assets/js/5.7bad488c.js"><link rel="prefetch" href="/assets/js/50.57a14f38.js"><link rel="prefetch" href="/assets/js/51.5a116b8b.js"><link rel="prefetch" href="/assets/js/52.a54a59bf.js"><link rel="prefetch" href="/assets/js/53.9075d9af.js"><link rel="prefetch" href="/assets/js/54.34f8aadb.js"><link rel="prefetch" href="/assets/js/55.c292b085.js"><link rel="prefetch" href="/assets/js/56.7519415a.js"><link rel="prefetch" href="/assets/js/57.810fdc3f.js"><link rel="prefetch" href="/assets/js/58.9bc00d0c.js"><link rel="prefetch" href="/assets/js/59.e8689e7a.js"><link rel="prefetch" href="/assets/js/6.246c264b.js"><link rel="prefetch" href="/assets/js/60.1158f326.js"><link rel="prefetch" href="/assets/js/61.44b53976.js"><link rel="prefetch" href="/assets/js/62.a49d1031.js"><link rel="prefetch" href="/assets/js/63.bab4d6cf.js"><link rel="prefetch" href="/assets/js/64.82de4224.js"><link rel="prefetch" href="/assets/js/65.2807528e.js"><link rel="prefetch" href="/assets/js/66.8b65a316.js"><link rel="prefetch" href="/assets/js/67.af845a49.js"><link rel="prefetch" href="/assets/js/68.2b737861.js"><link rel="prefetch" href="/assets/js/69.f2e79d15.js"><link rel="prefetch" href="/assets/js/7.ed62b6c5.js"><link rel="prefetch" href="/assets/js/70.57aafe84.js"><link rel="prefetch" href="/assets/js/71.902fd192.js"><link rel="prefetch" href="/assets/js/73.ae5294f6.js"><link rel="prefetch" href="/assets/js/74.7355f57e.js"><link rel="prefetch" href="/assets/js/75.6aeee33e.js"><link rel="prefetch" href="/assets/js/76.08a65d24.js"><link rel="prefetch" href="/assets/js/77.41f5bc62.js"><link rel="prefetch" href="/assets/js/78.525edd26.js"><link rel="prefetch" href="/assets/js/79.9600b1bb.js"><link rel="prefetch" href="/assets/js/8.14da4f18.js"><link rel="prefetch" href="/assets/js/80.e49236a4.js"><link rel="prefetch" href="/assets/js/81.8f4c7693.js"><link rel="prefetch" href="/assets/js/82.a612cd71.js"><link rel="prefetch" href="/assets/js/83.50f781a3.js"><link rel="prefetch" href="/assets/js/84.658119b6.js"><link rel="prefetch" href="/assets/js/85.321c942e.js"><link rel="prefetch" href="/assets/js/86.4a43b9cb.js"><link rel="prefetch" href="/assets/js/87.9c87c8e2.js"><link rel="prefetch" href="/assets/js/88.4610c77c.js"><link rel="prefetch" href="/assets/js/89.8c2033b9.js"><link rel="prefetch" href="/assets/js/9.2039e18f.js"><link rel="prefetch" href="/assets/js/90.3ad36c14.js"><link rel="prefetch" href="/assets/js/91.c53713b1.js"><link rel="prefetch" href="/assets/js/92.3633a7bf.js"><link rel="prefetch" href="/assets/js/93.b9a037b9.js"><link rel="prefetch" href="/assets/js/94.eb154f92.js"><link rel="prefetch" href="/assets/js/95.20101364.js"><link rel="prefetch" href="/assets/js/96.90b693c7.js"><link rel="prefetch" href="/assets/js/97.0894f8f6.js"><link rel="prefetch" href="/assets/js/98.ecb3fad5.js"><link rel="prefetch" href="/assets/js/99.818f7077.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d0479855.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar boxshadow"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Marcin Jahn | Technology Notebook</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/programming/" class="nav-link router-link-active">
  Programming
</a></div><div class="nav-item"><a href="/dev-tools/" class="nav-link">
  Tools and Infrastructure
</a></div><div class="nav-item"><a href="/technologies/" class="nav-link">
  Technologies
</a></div><div class="nav-item"><a href="/projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="/meta/" class="nav-link">
  Meta
</a></div> <span class="external-services" data-v-10a38898><a target="_blank" href="https://www.linkedin.com/in/marcin-jahn-63a9b915b/?locale=en_US" data-v-f9b87572 data-v-10a38898><img src="/img/linkedin.webp" data-v-f9b87572></a><a target="_blank" href="https://github.com/marcinjahn" data-v-f9b87572 data-v-10a38898><img src="/img/github.webp" data-v-f9b87572></a></span> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/programming/" class="nav-link router-link-active">
  Programming
</a></div><div class="nav-item"><a href="/dev-tools/" class="nav-link">
  Tools and Infrastructure
</a></div><div class="nav-item"><a href="/technologies/" class="nav-link">
  Technologies
</a></div><div class="nav-item"><a href="/projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="/meta/" class="nav-link">
  Meta
</a></div> <span class="external-services" data-v-10a38898><a target="_blank" href="https://www.linkedin.com/in/marcin-jahn-63a9b915b/?locale=en_US" data-v-f9b87572 data-v-10a38898><img src="/img/linkedin.webp" data-v-f9b87572></a><a target="_blank" href="https://github.com/marcinjahn" data-v-f9b87572 data-v-10a38898><img src="/img/github.webp" data-v-f9b87572></a></span> <!----></nav>  <ul class="sidebar-links"><li><a href="/programming/" aria-current="page" class="sidebar-link">/programming/</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>.NET</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/programming/dotnet/http-client.html" class="sidebar-link">HTTPClient</a></li><li><a href="/programming/dotnet/async.html" class="sidebar-link">Async</a></li><li><a href="/programming/dotnet/equality.html" class="sidebar-link">Equality</a></li><li><a href="/programming/dotnet/comparisons.html" class="sidebar-link">Comparisons</a></li><li><a href="/programming/dotnet/generic-host.html" class="sidebar-link">Generic Host</a></li><li><a href="/programming/dotnet/logging.html" class="sidebar-link">Logging</a></li><li><a href="/programming/dotnet/configuration.html" class="sidebar-link">Configuration</a></li><li><a href="/programming/dotnet/records.html" class="sidebar-link">Records</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ASP.NET Core</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Entity Framework Core</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/programming/dotnet/entity-framework-core/" aria-current="page" class="active sidebar-link">Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#nuget" class="sidebar-link">NuGet</a></li><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#dbcontext" class="sidebar-link">DbContext</a></li><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#conventions" class="sidebar-link">Conventions</a></li><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#migrations" class="sidebar-link">Migrations</a></li><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#scaffolding" class="sidebar-link">Scaffolding</a></li><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#relations" class="sidebar-link">Relations</a></li><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#queries" class="sidebar-link">Queries</a></li><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#removing-data" class="sidebar-link">Removing Data</a></li><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#adding-rows" class="sidebar-link">Adding Rows</a></li><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#updates" class="sidebar-link">Updates</a></li><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#keyless-entities" class="sidebar-link">Keyless Entities</a></li><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#raw-sql" class="sidebar-link">Raw SQL</a></li><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#logging" class="sidebar-link">Logging</a></li><li class="sidebar-sub-header"><a href="/programming/dotnet/entity-framework-core/#batching" class="sidebar-link">Batching</a></li></ul></li><li><a href="/programming/dotnet/entity-framework-core/testing.html" class="sidebar-link">Testing</a></li><li><a href="/programming/dotnet/entity-framework-core/tips.html" class="sidebar-link">Tips</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Functional Programming</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Rust</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>C/C++</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Algorithms</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content"><div class="content__default"><h1 id="overview-of-entity-framework-core"><a href="#overview-of-entity-framework-core" class="header-anchor">#</a> Overview of Entity Framework Core</h1> <p>EF Core is the official .NET data access technology. It's an ORM (Object
Relational Mapper), providing some framework for how to work with the data
layer. It allows accessing Tables, Stored Procedures, Views, and more.</p> <h2 id="nuget"><a href="#nuget" class="header-anchor">#</a> NuGet</h2> <ul><li><code>Microsoft.EntityFrameworkCore</code> - just the core logic, no providers;</li> <li><code>Microsoft.EntityFrameworkCore.SqlServer</code> - SQL Server provider, installing it
will also pull in the above package as its dependency.</li> <li><code>Microsoft.EntityFrameworkCore.Design</code> - a package that is needed for invoking
migrations</li></ul> <h2 id="dbcontext"><a href="#dbcontext" class="header-anchor">#</a> DbContext</h2> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SamuraiContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>Samurai<span class="token punctuation">&gt;</span></span> Samurais <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>Quote<span class="token punctuation">&gt;</span></span> Quotes <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The tables names are inferred from the <code>DbSet&lt;&gt;</code> names.</p> <div class="custom-block tip"><p class="custom-block-title">Optional DbSet</p> <p>The <code>DbSet</code> properties are not required. We can have a table without a <code>DbSet</code>
pointing to it. <code>DbSet</code> is a convenience that:</p> <ul><li>simplifies navigation to that table from the <code>DbContext</code></li> <li>provides a name for the table</li></ul> <p>Without a <code>DbSet</code> defined in the <code>DbContext</code>, we can retrieve it as follows:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> <span class="token keyword">set</span> <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>BattleSamurai<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <h3 id="savechanges"><a href="#savechanges" class="header-anchor">#</a> SaveChanges</h3> <p>The <code>DbContext</code> tracks changes so that they can be applied when we call
<code>SaveChanges()</code> on it.</p> <p>A <code>SaveChanges()</code> call applies all the requests to the database wrapped in a
transaction, so failure of some requests will not corrupt the database.</p> <h3 id="notracking"><a href="#notracking" class="header-anchor">#</a> NoTracking</h3> <p>In some cases, we're not interested in <code>DbContext</code>'s tracking capabilities,
especially when building web APIs where we often fire some query to the DB and
dispose of the connection. In such cases we can enable <strong>NoTracking</strong> to improve
performance.</p> <p>We can do that in a few ways:</p> <ul><li><p>in queries - useful when we normally want tracking, but for some specific
query we don't:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> samurai <span class="token operator">=</span> _context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">AsNoTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>on <code>DbContext</code> - makes all queries NoTracking by default:</p> <div class="language-csharp extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyContext</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ChangeTracker<span class="token punctuation">.</span>QueryTrackingBehaviour <span class="token operator">=</span> QueryTrackingBehaviour<span class="token punctuation">.</span>NoTracking<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>in Dependency Injection registration:</p> <div class="language-csharp extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-csharp"><code>builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContext</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SamuraiContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    options
        <span class="token punctuation">.</span><span class="token function">UseSqlServer</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">&quot;SamuraiDb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">UseQueryTrackingBehavior</span><span class="token punctuation">(</span>QueryTrackingBehavior<span class="token punctuation">.</span>NoTracking<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <div class="custom-block tip"><p class="custom-block-title">Only Queries</p> <p>The above methods only impact the tracking of entities that are being queried
via EF Core. Entities being added or updated are still being tracked, which is a
good thing. Otherwise, we'd have to set any entity as &quot;Modified&quot; or &quot;Added&quot;
explicitly every time.</p></div> <h3 id="connection"><a href="#connection" class="header-anchor">#</a> Connection</h3> <p>In EF Core we need to explicitly provide info on which provider to use and what
is the connection string. Here's the simplest way to do it:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SamuraiContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>Samurai<span class="token punctuation">&gt;</span></span> Samurais <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>Quote<span class="token punctuation">&gt;</span></span> Quotes <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnConfiguring</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptionsBuilder</span> optionsBuilder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        optionsBuilder<span class="token punctuation">.</span><span class="token function">UseSqlServer</span><span class="token punctuation">(</span><span class="token string">&quot;Server=localhost;Database=SamuraiAppData;User Id=sa;Password=Qwerty1!;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In a real scenario, we'd obviously not hardcode the connection string.</p> <h2 id="conventions"><a href="#conventions" class="header-anchor">#</a> Conventions</h2> <p>EF Core has a bunch of conventions that are applied by default. Here're some of
them:</p> <ul><li><p>Property called <code>Id</code> or <code>&lt;Class&gt;Id</code> will become a Primary Key</p></li> <li><p>for every Foreign Key, an index is created</p></li> <li><p>a <code>string</code> type is turned into <code>nvarchar(MAX)</code> in the DB (that's a default
from SQL Server provider, not the EF Core itself)</p></li> <li><p>When C#'s Nullable feature is enabled, reference types are &quot;not nullable&quot; by
default - the same applies to DB table's columns</p></li> <li><p>DB tables names come from <code>DbSet</code>'s name or, if <code>DbSet</code> was not defined, from
a class's name.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// We can also name the table whatever we want</span>
modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Horse<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToTable</span><span class="token punctuation">(</span><span class="token string">&quot;MyHorses&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <p>The conventions can be tweaked with:</p> <ul><li>Data Annotations</li> <li>Fluent API (more powerful)</li></ul> <h2 id="migrations"><a href="#migrations" class="header-anchor">#</a> Migrations</h2> <p>Every change of data model is a prompt to do a migration. This way the
database's shape corresponds to our code model. Migrations are files and they
are supposed to land in the VCS.</p> <p>Migrations history is kept in the DB itself, in the &quot;__EFMigrationsHistory&quot;
table.</p> <h3 id="creating-migration"><a href="#creating-migration" class="header-anchor">#</a> Creating Migration</h3> <p>Command: <code>dotnet ef migrations add &lt;NAME&gt;</code>. It should be invoked from a
directory of a .NET project containig <code>DbContext</code>.</p> <div class="custom-block tip"><p class="custom-block-title">DbContext Initialization</p> <p>The command tries to instantiate <code>DbContext</code>. By default it looks for that logic
in the project in the current directory. If a different .NET project has this
logic (e.g. some ASP.NET Core project), we need to point to it. Here's an
example:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>dotnet ef migrations <span class="token function">add</span> -s <span class="token punctuation">..</span>/WebApi/WebAPI.csproj MyMigration
</code></pre></div></div> <p>When adding a migration, the file <code>Migrations/*ModelSnapshot.cs</code> is loaded and
compared with the current <code>DbContext</code>. Based on the difference between these, a
new migration file is generated.</p> <div class="custom-block tip"><p class="custom-block-title">First Migration</p> <p>When the first migration is being created, the <code>*ModelSnapshot.cs</code> file will be
created as well.</p></div> <p>A migration file's name contains a timestamp and migrations's name. It is a
class with 2 methods:</p> <ul><li><code>Up</code> - work to do when the migration is applied</li> <li><code>Down</code> - work to do when the particular migration is revoked</li></ul> <div class="custom-block danger"><p class="custom-block-title">DROP</p> <p>In cases when we have data in the DB, we should always look at the migration file
to make sure that it's going to do only what we expected. In some cases, after
changing various names, it might happen that the migration will <code>DROP</code> a table
and recreate it, which would be a loss of existing data.</p></div> <div class="custom-block tip"><p class="custom-block-title">Empty Migrations</p> <p>If we have a specific case we can create an empty migration and code the logic
of that migration directly in its file. E.g., we could use
<code>migrationBuilder.Sql()</code> method to provide some <a href="#raw-sql">SQL to be executed</a>.</p></div> <h3 id="applying-migration"><a href="#applying-migration" class="header-anchor">#</a> Applying Migration</h3> <p>The EF Tool can either execute the migration (good in DEV), or it can generate
an SQL file with all the migration steps (good for PROD) - we can then execute
it later on.</p> <p>Generating a script: <code>dotnet ef migrations script &lt;FROM&gt; &lt;TO&gt;</code> - the SQL is
printed to stdout. We can specify the migration to start from and the one we
want to get to. By default it would generate SQL for all the migrations.</p> <div class="custom-block warning"><p class="custom-block-title">Creating database</p> <p>When applying migration with EF tool directly, it makes sure that the database
exists and creates it if needed. When using the SQL script, it's our
responsibility to provide an existing database.</p> <p>A fragment of logs when running the <code>dotnet ef database update -v</code>:</p> <div class="language-log extra-class"><pre class="language-log"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Opening connection to database <span class="token string">'MyNewDB'</span> on server <span class="token string">'localhost'</span><span class="token punctuation">.</span>
An error occurred using the connection to database <span class="token string">'MyNewDB'</span> on server <span class="token string">'localhost'</span><span class="token punctuation">.</span>
Opening connection to database <span class="token string">'master'</span> on server <span class="token string">'localhost'</span><span class="token punctuation">.</span>
Opened connection to database <span class="token string">'master'</span> on server <span class="token string">'localhost'</span><span class="token punctuation">.</span>
Creating DbCommand for <span class="token string">'ExecuteNonQuery'</span><span class="token punctuation">.</span>
Created DbCommand for <span class="token string">'ExecuteNonQuery'</span> <span class="token operator">(</span><span class="token number">1ms</span><span class="token operator">)</span><span class="token punctuation">.</span>
Executing DbCommand <span class="token punctuation">[</span>Parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> CommandType<span class="token operator">=</span><span class="token string">'Text'</span><span class="token punctuation">,</span> CommandTimeout<span class="token operator">=</span><span class="token string">'60'</span><span class="token punctuation">]</span>
CREATE DATABASE <span class="token punctuation">[</span>SamuraiAppData<span class="token punctuation">]</span><span class="token operator">;</span>
Executed DbCommand <span class="token operator">(</span><span class="token number">461ms</span><span class="token operator">)</span> <span class="token punctuation">[</span>Parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> CommandType<span class="token operator">=</span><span class="token string">'Text'</span><span class="token punctuation">,</span> CommandTimeout<span class="token operator">=</span><span class="token string">'60'</span><span class="token punctuation">]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div></div> <div class="custom-block tip"><p class="custom-block-title">DbContext initialization</p> <p>Just like with migration creation, we need to point the EF Tool to the project
that contains <code>DbContext</code> creation logic:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>dotnet ef database update -s <span class="token punctuation">..</span>/WebAPI/WebAPI.csproj
</code></pre></div></div> <h3 id="tools"><a href="#tools" class="header-anchor">#</a> Tools</h3> <p>The migration tools can be installed as a NuGet package, or as a dotnet CLI tool
(<code>dotnet tool install --global dotnet-ef</code>). The CLI tool is invoked with <code>dotnet ef</code>.</p> <p>Additionally, we'd need to install the <code>Microsoft.EntityFrameworkCore.Design</code>
NuGet package to access the Migration APIs from code.</p> <h2 id="scaffolding"><a href="#scaffolding" class="header-anchor">#</a> Scaffolding</h2> <p>The &quot;Code First&quot; approach is recommended, but it is also possible to kind of
reverse engineer a DB into models. The EF Tool has the <code>scaffold</code> subcommand for
such a usecase.</p> <h2 id="relations"><a href="#relations" class="header-anchor">#</a> Relations</h2> <h3 id="one-to-many"><a href="#one-to-many" class="header-anchor">#</a> One-to-Many</h3> <p>If an entity contains a collection of another entity, EF Core treats it as a
one-to-many relationship.</p> <p>The child entity can optionally have a property of a type of a parent - it
will be a reference. The child may also have an ID property that would be a
Foreign Key to the parent. EF Core will initialize these properties for us.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Quote</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Text <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">// optional</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Samurai</span> Samurai <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// Navigation Property (reference to parent)</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> SamuraiId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// FK - it helps EF Core to know that Quote is  a &quot;child&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Naming</p> <p>Names of the optional properties should follow conventions to be recognized by
EF Core. We could also configure our own conventions.</p></div> <h3 id="many-to-many"><a href="#many-to-many" class="header-anchor">#</a> Many-to-Many</h3> <p>To create many-to-many, we just need two entities referring to each other via
collections:</p> <div class="language-csharp extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Samurai</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>Battle<span class="token punctuation">&gt;</span></span> Battles <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Battle<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Battle</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> BattleId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>Samurai<span class="token punctuation">&gt;</span></span> Samurais <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Samurai<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>EF Core has a convention that understands it and it will create three tables:</p> <ul><li>Samurais</li> <li>Battles</li> <li>BattleSamurai - association of BattleIds with SamuraiIds (the PK will be a
combination of these two FKs)</li></ul> <p>It's called <strong>Skip Navigation</strong>, because in code we can forget about the
intermediary table and just work with the two entities being related.</p> <div class="custom-block tip"><p class="custom-block-title">Join class name</p> <p>The join class (e.g., BattleSamurai) was named by following EF Core's
convention: class names are placed alphabetically. That's why it's
&quot;BattleSamurai&quot; and not &quot;SamuraiBattle&quot;.</p></div> <h4 id="join-class"><a href="#join-class" class="header-anchor">#</a> Join Class</h4> <p>For simplest cases, the above is enough. For some more advanced scenarios, we
need to create additional class that joins our entities together.</p> <div class="custom-block tip"><p class="custom-block-title">EF Core &lt; 5.0</p> <p>In older versions of EF Core, it was mandatory to create such a class for every
many-to-many relationship.</p></div> <p>Here's an example of a class joining two entites (with some metadata):</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BattleSamurai</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> SamuraiId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> BattleId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> DateJoined <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This class represents the connection between a Samurai and a Battle. It's
similar to the SQL table that EF Core creates behind the sceness. We've added a
<code>DateJoined</code> parameter as some metadata about the connection (often called
&quot;Payload&quot;).</p> <p>Additionally, we have to update the <code>DbContext</code> to explicitly specify the
relationship:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SamuraiContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>Samurai<span class="token punctuation">&gt;</span></span> Samurais <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>Battle<span class="token punctuation">&gt;</span></span> Battles <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnModelCreating</span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> modelBuilder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Samurai<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// Many-to-many</span>
            <span class="token punctuation">.</span><span class="token function">HasMany</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Battles<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">WithMany</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span> b<span class="token punctuation">.</span>Samurais<span class="token punctuation">)</span>
            <span class="token comment">// Use the class we've created (BattleSamurai)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UsingEntity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>BattleSamurai<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
                bs <span class="token operator">=&gt;</span> bs<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">HasOne</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Battle<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                bs <span class="token operator">=&gt;</span> bs<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">HasOne</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Samurai<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// Configure default value for DateJoined</span>
            <span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>bs <span class="token operator">=&gt;</span> bs<span class="token punctuation">.</span>DateJoined<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">HasDefaultValueSql</span><span class="token punctuation">(</span><span class="token string">&quot;getdate()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>For the simplest cases we wouldn't have to do such configuration.</p> <h3 id="one-to-one"><a href="#one-to-one" class="header-anchor">#</a> One-to-One</h3> <p>By default, the &quot;principal&quot; does not have to have any &quot;dependant&quot;, while the
&quot;dependant&quot; has to have a &quot;principal&quot;.</p> <p>In the DB, the &quot;dependant&quot; will have FK to the &quot;principal&quot;. The &quot;principal&quot; will
not have FK to the &quot;dependant&quot;.</p> <p>Example:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// Principal</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Samurai</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Horse</span> Horse <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// Naigation Property to the Dependant</span>
<span class="token punctuation">}</span>

<span class="token comment">// Dependant</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Horse</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> SamuraiId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// FK to the Principal</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Single Table</p> <p>With some configuration, we can make the one-to-one relationship to be stored in
a single table (of the &quot;principal&quot;). By default, two tables are used.</p></div> <h2 id="queries"><a href="#queries" class="header-anchor">#</a> Queries</h2> <p>EF Core automatically generates <code>SELECT</code> queries when accessing objects. We can
also customize the query that EF Core executes on the <code>DbContext</code> level.</p> <h3 id="execution-methods"><a href="#execution-methods" class="header-anchor">#</a> Execution Methods</h3> <p>The following methods allow us to query on <code>DbSet</code>s:</p> <ul><li><code>ToList()</code></li> <li><code>First()</code></li> <li><code>FirstOrDefault()</code></li> <li><code>Single()</code> - expects just one result to be found in the DB, throws otherwise</li> <li><code>SingleOrDefault()</code></li> <li><code>Last()</code> - should be preceed by the <code>OrderBy</code> call</li> <li><code>LastOrDefault()</code> - should be preceed by the <code>OrderBy</code> call</li> <li><code>Count()</code></li> <li><code>LongCount()</code></li> <li><code>Min()</code></li> <li><code>Max()</code></li> <li><code>Average()</code></li> <li><code>Sum()</code></li> <li><code>Find(PK_value)</code> - not LINQ, it's <code>DbSet</code>'s method that looks for a row with a
specified key</li></ul> <div class="custom-block tip"><p class="custom-block-title">Async</p> <p>All these methods also have the async counterparts.</p></div> <h3 id="parametrizing"><a href="#parametrizing" class="header-anchor">#</a> Parametrizing</h3> <p>When invoking queries on the DB, the parameters that we provide may be
parametrized or not. If we use a variable to provide some parameter, SQL will be
parametrized. If we provide a hardcoded string, it will not be parametrized.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// Parametrized</span>
<span class="token class-name"><span class="token keyword">var</span></span> name <span class="token operator">=</span> <span class="token string">&quot;Sampson&quot;</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> samurais <span class="token operator">=</span> _context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Name <span class="token operator">==</span> name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Not parametrized</span>
<span class="token class-name"><span class="token keyword">var</span></span> samurais <span class="token operator">=</span> _context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">&quot;Sampson&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="related-data"><a href="#related-data" class="header-anchor">#</a> Related Data</h3> <p>By default, when pulling some entities, their related entities are not fetched.
E.g., if I have a 1-to-Many relationship between samurais and quotes, if I query
for the samurai, the list of quotes will be empty.</p> <h4 id="eager-loading"><a href="#eager-loading" class="header-anchor">#</a> Eager Loading</h4> <p>With Eager Loading and its <code>Include</code> method, we can specify Navigation
Properties that should be populated with the query:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> samuraiWithQuotes <span class="token operator">=</span> _context<span class="token punctuation">.</span>Samurais
    <span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Quotes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>The resulting query will make use of <code>OUTER JOIN</code> to get data from both the
&quot;Samurais&quot; and &quot;Quotes&quot; tables. There's an option to send separate queries as
well (<code>AsSplitQuery()</code>).</p></div> <h5 id="filtered-query"><a href="#filtered-query" class="header-anchor">#</a> Filtered Query</h5> <p>When including some child, we can filter it as well:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> samuraiWithQuotes <span class="token operator">=</span> _context<span class="token punctuation">.</span>Samurais
    <span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Quotes<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>q <span class="token operator">=&gt;</span> q<span class="token punctuation">.</span>Text<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">&quot;abc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="other-variations"><a href="#other-variations" class="header-anchor">#</a> Other Variations</h5> <p>Here are some other sceanarios for Eager Loading:</p> <ul><li><p>Include children and grandchildren:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>context<span class="token punctuation">.</span>Samurais
    <span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Quotes<span class="token punctuation">)</span> <span class="token comment">// many-to-many</span>
    <span class="token punctuation">.</span><span class="token function">ThenInclude</span><span class="token punctuation">(</span>q <span class="token operator">=&gt;</span> q<span class="token punctuation">.</span>Translations<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// one-to-many</span>
</code></pre></div></li> <li><p>Include just grandchildren:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>context<span class="token punctuation">.</span>Samurais
    <span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Quotes<span class="token punctuation">.</span>Translations<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>Include different children:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>context<span class="token punctuation">.</span>Samurais
    <span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Quotes<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Clan<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h4 id="explicit-loading"><a href="#explicit-loading" class="header-anchor">#</a> Explicit Loading</h4> <p>Explicit Loading allows to load related data when the &quot;base&quot; entity is already
loaded:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> samurai <span class="token operator">=</span> context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>samurai<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Collection</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Quotes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// one-to-many</span>
context<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>samurai<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Reference</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Horse<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//one-to-one</span>
</code></pre></div><h4 id="lazy-loading"><a href="#lazy-loading" class="header-anchor">#</a> Lazy Loading</h4> <p>Lazy Loading fetches the data from the DB as soon as we try to access some
related data via a Navigation Property.</p> <div class="custom-block tip"><p class="custom-block-title">OFF</p> <p>Lazy Loading is disabled by default due to its performance overhead.</p></div> <h3 id="limiting-properties"><a href="#limiting-properties" class="header-anchor">#</a> Limiting Properties</h3> <p>We can limit the properties to be returned with <code>Select</code>:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> someProps <span class="token operator">=</span> context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> s<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> s<span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In this case a list of anoymous objects will be returned, but we could use some
known type as well.</p> <div class="custom-block tip"><p class="custom-block-title">Related Data</p> <p>We can use <code>Select</code> to bring in related data as well and use it instead of
<a href="#eager-loading">Eager Loading</a>.</p></div> <p>An interesting usecase of that is to bring in just the count of some related data:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> someProps <span class="token operator">=</span> context<span class="token punctuation">.</span>Samurais
    <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span>
        <span class="token keyword">new</span> <span class="token punctuation">{</span> s<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> s<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> QuotesCount <span class="token operator">=</span> s<span class="token punctuation">.</span>Quotes<span class="token punctuation">.</span>Count <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">Tracking</p> <p>When projecting entities to custom/anonymous types, EF Core's <code>DbContext</code> is not
able to track the pulled entities.</p></div> <h3 id="like"><a href="#like" class="header-anchor">#</a> LIKE</h3> <p>We can use SQL's <code>LIKE</code> with the <code>EF.Functions.Like</code> function:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> samurais <span class="token operator">=</span> _context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> EF<span class="token punctuation">.</span>Functions<span class="token punctuation">.</span><span class="token function">Like</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">&quot;J%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="removing-data"><a href="#removing-data" class="header-anchor">#</a> Removing Data</h2> <p>Here's how to remove some entity</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> samurai <span class="token operator">=</span> _context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
_context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>samurai<span class="token punctuation">)</span><span class="token punctuation">;</span>
_context<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="many-to-many-2"><a href="#many-to-many-2" class="header-anchor">#</a> Many-to-Many</h3> <p>Here's how to remove a Many-to-Many relationship:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> battle <span class="token operator">=</span> _context<span class="token punctuation">.</span>Battles<span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>n <span class="token operator">=&gt;</span> n<span class="token punctuation">.</span>Samurais<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
battle<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">RemoveAll</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// remove all samurais from a battle</span>
<span class="token comment">// battle.Samurais.Remove(battle.Samurais.First()); // remove a single samurai from a battle</span>
_context<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>Include</code> above is crucial. If we fetched battles without samurais,
<code>DbContext</code> would not &quot;know&quot; that any samurais were in the battle, and the
<code>Remove</code> call would not have any result.</p> <p>In case when we're using a more explicit Many-to-Many relationship, with a Join
table class defined, we can remove an association as follows:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> bs <span class="token operator">=</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>BattleSamurai<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">SingleOrDefault</span><span class="token punctuation">(</span>bs <span class="token operator">=&gt;</span> bs<span class="token punctuation">.</span>BattleId <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> bs<span class="token punctuation">.</span>SamuraiId <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bs <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _context<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>b_s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _context<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Modifying payload</p> <p>If we want to modify some payload data of a many-to-many relationship, we'd have
to modify the join class object, similarly to the code above.</p></div> <h2 id="adding-rows"><a href="#adding-rows" class="header-anchor">#</a> Adding Rows</h2> <p>We can add new rows:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>newSamurai<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// or</span>
context<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>newSamurai<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="updates"><a href="#updates" class="header-anchor">#</a> Updates</h2> <p>We can update the entities as follows:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> samurai <span class="token operator">=</span> _context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
samurai<span class="token punctuation">.</span>Name <span class="token operator">+=</span> <span class="token string">&quot;San&quot;</span><span class="token punctuation">;</span>
_context<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Since the same <code>DbContext</code> instance was used to retrieve the object and to
update it, EF Core knows which properties have been updated. The SQL sent to the
DB will contain only the modified values.</p> <p>In disconnected scenarios, the case is that we have to update some entity
without retrieving it first (e.g., in some Web API). Then, we can do that as
follows:</p> <div class="language-csharp extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-csharp"><code><span class="token comment">// 'data' could be delivered in the body of a PUT request</span>

<span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SamuraiContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In such a case, since the context is fresh and does not &quot;know&quot; which properties
have been changed, the SQL sent to the DB will contain all the properties of the
entity to be updated.</p> <h3 id="attach"><a href="#attach" class="header-anchor">#</a> Attach</h3> <p>When using <code>Update</code> in the disconnected scenarios with related data, EF Core is
going to send unneeded requests to the DB. Here's an example:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> samurai <span class="token operator">=</span> _context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>samuraiId<span class="token punctuation">)</span><span class="token punctuation">;</span>
samurai<span class="token punctuation">.</span>Quotes<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Quote</span>
    <span class="token punctuation">{</span>
        Text <span class="token operator">=</span> <span class="token string">&quot;Some quote&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Disconnected</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> newContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SamuraiContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    newContext<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>samurai<span class="token punctuation">)</span><span class="token punctuation">;</span>
    newContext<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In this case, not only a new quote will be created, but also samurai's
properties will be updated (all of them). The <code>newContext</code> is fresh, it did not
track anything, and it doesn't &quot;know&quot; what exactly has changed. To make sure
that DB is in proper state it will send to it everything.</p> <p>We can use <code>Attach</code> to circumvent that.</p> <div class="language-csharp extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-csharp"><code><span class="token comment">// Disconnected</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> newContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SamuraiContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    newContext<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">Attach</span><span class="token punctuation">(</span>samurai<span class="token punctuation">)</span><span class="token punctuation">;</span>
    newContext<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When using <code>Attach</code> the <code>DbContext</code> (<code>newContext</code> in this case) will not treat
the provided data as &quot;Modified&quot;. Instead, it will treat it as &quot;Unchanged&quot;.
However, EF Core sees that one of the quotes in the samurai does not have a
value for the <code>Id</code> (PK), and for the <code>SamuraiId</code> (FK). It will understand that
this data needs to be sent to the DB.</p> <p>Another approach would be to add the <code>Quote</code> to the DB directly, instead of
doing that via a samurai. For this to work, we need to have a FK property of
<code>Quote</code>:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> quote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Quote</span> <span class="token punctuation">{</span> Text <span class="token operator">=</span> <span class="token string">&quot;Some text&quot;</span><span class="token punctuation">,</span> SamuraiId <span class="token operator">=</span> samuraiId <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> newContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SamuraiContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
newContext<span class="token punctuation">.</span>Quotes<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>quote<span class="token punctuation">)</span><span class="token punctuation">;</span>
newContext<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="updating-related-entity"><a href="#updating-related-entity" class="header-anchor">#</a> Updating Related Entity</h3> <p>A similar issue that we had with a single entity when updating it in a
Disconnected scenario occurs if we want to update some entity with relations:</p> <div class="language-csharp extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> quote <span class="token operator">=</span> context<span class="token punctuation">.</span>Samurais
    <span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Quotes<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Id <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>Quotes
    <span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

quote<span class="token punctuation">.</span>Text <span class="token operator">+=</span> <span class="token string">&quot;Some update&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Disconnected</span>
<span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> newContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SamuraiContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
newContext<span class="token punctuation">.</span>Quotes<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>quote<span class="token punctuation">)</span><span class="token punctuation">;</span>
newContext<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>Update()</code> call here might be very &quot;heavy&quot;. It will not only update the
quote, but also the samurai, and all the other quotes that it has! A fresh
<code>DbContext</code> instance does not know what the previous state was, so it will try
to update everything.</p> <p>Replacing <code>Update</code> with <code>Attach</code> method will not help in this case, because it
will just mark all entities as &quot;Unmodified&quot; and EF Core will not issue any
updates at all. The modified quote already has <code>Id</code> and <code>SamuraiId</code>, so the
previous solution doesn't work. We should use the following approach:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>newContext<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>quote<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> EntityState<span class="token punctuation">.</span>Modified<span class="token punctuation">;</span>
newContext<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We're manually informing EF Core that this quote was modified. Only this one
entity will be updated, related data is left unchanged - just one <code>UPDATE</code>
command will be sent to the DB.</p> <h2 id="keyless-entities"><a href="#keyless-entities" class="header-anchor">#</a> Keyless Entities</h2> <p>EF Core 3.0 introduced the possibility to have entities without PK.
Here's how we can use it:</p> <p>Create an entity:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SamuraiBattleStat</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">?</span></span> NumberOfBattles <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> EarliestBattle <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Add a <code>DbSet</code> to the <code>DbContext</code>:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>SamuraiBattleStat<span class="token punctuation">&gt;</span></span> SamuraiBattleStats <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre></div><p>Configure the entity to be keyless in <code>OnModelCreating</code> of the <code>DbContext</code>:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SamuraiBattleStat<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasNoKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Tracking</p> <p>Keyless entities are not tracked by <code>DbContext</code> and it cannot be enabled.</p></div> <div class="custom-block warning"><p class="custom-block-title">Find() Method</p> <p>Even though a keyless entity may be a <code>DbSet</code> we cannot use <code>DbSet</code>'s <code>Find()</code>
method on it - there's no key after all! The code will compile just fine, but an
exception will be thrown in the runtime.</p></div> <h3 id="views"><a href="#views" class="header-anchor">#</a> Views</h3> <p>In case the <code>SamuraiBattleStat</code> is supposed to be a View in the DB, we need
to configure it as follows:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SamuraiBattleStat<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasNoKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToView</span><span class="token punctuation">(</span><span class="token string">&quot;SamuraiBattleStats&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Without that, EF Core would create a new table.</p> <div class="custom-block warning"><p class="custom-block-title">Creating Views</p> <p>EF Core cannot create Views. They need to be created externally (e.g., with some
migration executing raw SQL). Even the migration generated after the above
change will be empty!</p></div> <h2 id="raw-sql"><a href="#raw-sql" class="header-anchor">#</a> Raw SQL</h2> <p>In special cases, we can use raw SQL in EF Core. It might be more performant
than relying on EF Core's queries.</p> <h3 id="migrations-2"><a href="#migrations-2" class="header-anchor">#</a> Migrations</h3> <p>For example, we might want to have a View or a Stored Procedure in our DB. To
create that, we'd create an empty migration and add SQL to that migration.
Here's an example:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">AddStoredProcedures</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Migration</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Up</span><span class="token punctuation">(</span><span class="token class-name">MigrationBuilder</span> migrationBuilder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        migrationBuilder<span class="token punctuation">.</span><span class="token function">Sql</span><span class="token punctuation">(</span>
        <span class="token string">@&quot;CREATE PROCEDURE dbo.DeleteQuotesForSamurai
            @samuraiId int
            AS
            DELETE FROM Quotes
            WHERE Quotes.SamuraiId=@samuraiId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Down</span><span class="token punctuation">(</span><span class="token class-name">MigrationBuilder</span> migrationBuilder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Remove</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="querying"><a href="#querying" class="header-anchor">#</a> Querying</h3> <p>Here's an example of how we can invoke raw SQL with a <code>DbContext</code>:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> samurais <span class="token operator">=</span> context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">FromSqlRaw</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM Samurais&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Since we used a <code>DbSet</code>, the result will be mapped to the entity of that
<code>DbSet</code>. The entities will be tracked as well.</p> <div class="custom-block warning"><p class="custom-block-title">Mapping</p> <p>There are some rules that we need to follow for the mapping to succeed:</p> <ul><li>The result must contain ALL the properties of the entity - not more, not less.</li> <li>The result cannot contain related data - we can go around it by attaching
<code>Include()</code> after the <code>FromSqlRaw()</code>.</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">Parametrized Strings</p> <p>We can use interpolation (e.g., <code>SELECT * FROM {tableName}</code>). Doing that is
safer with <code>FromSqlInterpolated()</code>. The SQL query will be parametrized.</p></div> <h3 id="stored-procedures"><a href="#stored-procedures" class="header-anchor">#</a> Stored Procedures</h3> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> samurais <span class="token operator">=</span> _context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">FromSqlInterpolated</span><span class="token punctuation">(</span>
    <span class="token interpolation-string"><span class="token string">$&quot;EXEC dbo.HomesWithNRooms </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">rooms</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="other-requests"><a href="#other-requests" class="header-anchor">#</a> Other Requests</h3> <p>There is also another way to invoke SQL commands:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>context<span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">ExecutrSqlRaw</span><span class="token punctuation">(</span><span class="token string">&quot;some SQL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>As a response we'll get just a number of rows affected by the command. We could
use it to execute some stored procedure that does not return data.</p> <h2 id="logging"><a href="#logging" class="header-anchor">#</a> Logging</h2> <p>We can configure logging in multiple ways.</p> <h3 id="tagging"><a href="#tagging" class="header-anchor">#</a> Tagging</h3> <p>Every interaction with the <code>DbContext</code> may be tagged with a comment that will be
visible on the SQL Server side.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> data <span class="token operator">=</span> _context<span class="token punctuation">.</span>Samurais<span class="token punctuation">.</span><span class="token function">TagWith</span><span class="token punctuation">(</span><span class="token string">&quot;Some comment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="logto"><a href="#logto" class="header-anchor">#</a> LogTo</h3> <p>A <code>DbContext</code> class may be configured with a <code>LogTo</code> call:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnConfiguring</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptionsBuilder</span> optionsBuilder<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    optionsBuilder<span class="token punctuation">.</span><span class="token function">LogTo</span><span class="token punctuation">(</span>Console<span class="token punctuation">.</span>WriteLine<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We'll see logs generated by EF Core in the console.</p> <p>By default, all values are hidden, since they might be sensitive. We can disable
that hiding with:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>optionsBuilder<span class="token punctuation">.</span><span class="token function">LogTo</span><span class="token punctuation">(</span>Console<span class="token punctuation">.</span>WriteLine<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">EnableSensitiveDataLogging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="generic-host"><a href="#generic-host" class="header-anchor">#</a> Generic Host</h3> <p>For apps using the Logging infrastructure, we don't have to do anything, logs
will already be there.</p> <h2 id="batching"><a href="#batching" class="header-anchor">#</a> Batching</h2> <p>If at least 4 operations have been added to the <code>DbContext</code>, EF Core will
execute a batch request instead of sending these operations/requests separately.</p></div> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/programming/dotnet/asp-net-core/tips.html" class="prev">
        Tips
      </a></span> <span class="next"><a href="/programming/dotnet/entity-framework-core/testing.html">
        Testing
      </a>
      →
    </span></p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/29/2022, 10:34:03 AM</span></div></footer> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.a0878009.js" defer></script><script src="/assets/js/2.a608218f.js" defer></script><script src="/assets/js/72.62b896d4.js" defer></script>
  </body>
</html>
