<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TPM Operations | Marcin Jahn | Technology Notebook</title>
    <meta name="generator" content="VuePress 1.8.2">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-ZSM2N36X8P"></script>
    <script>(function() { if (window.location.href.startsWith('http://localhost')) { return; } window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-ZSM2N36X8P'); })();</script>
    <meta name="description" content="Information about some fundamental operations that TPM is capable of doing">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.2d0603d3.css" as="style"><link rel="preload" href="/assets/js/app.87cbde57.js" as="script"><link rel="preload" href="/assets/js/2.f59378ff.js" as="script"><link rel="preload" href="/assets/js/8.f2bdf25f.js" as="script"><link rel="prefetch" href="/assets/js/10.404a5336.js"><link rel="prefetch" href="/assets/js/11.26ad847d.js"><link rel="prefetch" href="/assets/js/12.f99024fc.js"><link rel="prefetch" href="/assets/js/13.7595fe03.js"><link rel="prefetch" href="/assets/js/14.19f0a33c.js"><link rel="prefetch" href="/assets/js/15.edd580e7.js"><link rel="prefetch" href="/assets/js/16.709a76fa.js"><link rel="prefetch" href="/assets/js/17.d31682fa.js"><link rel="prefetch" href="/assets/js/18.d418f3ca.js"><link rel="prefetch" href="/assets/js/19.5b6bae1a.js"><link rel="prefetch" href="/assets/js/20.b1296514.js"><link rel="prefetch" href="/assets/js/21.d9a411b5.js"><link rel="prefetch" href="/assets/js/22.a73f3628.js"><link rel="prefetch" href="/assets/js/23.e152ce40.js"><link rel="prefetch" href="/assets/js/24.f859344d.js"><link rel="prefetch" href="/assets/js/25.be380422.js"><link rel="prefetch" href="/assets/js/26.e729f0e8.js"><link rel="prefetch" href="/assets/js/27.6ebfc58b.js"><link rel="prefetch" href="/assets/js/28.10c80a6b.js"><link rel="prefetch" href="/assets/js/29.80ac4173.js"><link rel="prefetch" href="/assets/js/3.17bc78ba.js"><link rel="prefetch" href="/assets/js/30.62e3c796.js"><link rel="prefetch" href="/assets/js/31.2901ad07.js"><link rel="prefetch" href="/assets/js/32.9cfa42d9.js"><link rel="prefetch" href="/assets/js/33.e2569108.js"><link rel="prefetch" href="/assets/js/34.8eefdba7.js"><link rel="prefetch" href="/assets/js/35.641ef4db.js"><link rel="prefetch" href="/assets/js/36.59cd48b1.js"><link rel="prefetch" href="/assets/js/37.b140d4b6.js"><link rel="prefetch" href="/assets/js/38.338e0e7f.js"><link rel="prefetch" href="/assets/js/39.23590df6.js"><link rel="prefetch" href="/assets/js/4.e66cdc67.js"><link rel="prefetch" href="/assets/js/40.d466dbc4.js"><link rel="prefetch" href="/assets/js/41.5b7d690d.js"><link rel="prefetch" href="/assets/js/42.c5526cf9.js"><link rel="prefetch" href="/assets/js/43.2d43a97b.js"><link rel="prefetch" href="/assets/js/44.55a58cf6.js"><link rel="prefetch" href="/assets/js/45.e90670ee.js"><link rel="prefetch" href="/assets/js/46.dbd4de3e.js"><link rel="prefetch" href="/assets/js/47.a6b24d05.js"><link rel="prefetch" href="/assets/js/48.547dd4f8.js"><link rel="prefetch" href="/assets/js/49.b38e8d7e.js"><link rel="prefetch" href="/assets/js/5.8fb6c804.js"><link rel="prefetch" href="/assets/js/50.85d4adbd.js"><link rel="prefetch" href="/assets/js/51.70928b4e.js"><link rel="prefetch" href="/assets/js/52.6cf81f03.js"><link rel="prefetch" href="/assets/js/53.43cdd428.js"><link rel="prefetch" href="/assets/js/54.c4ec2f87.js"><link rel="prefetch" href="/assets/js/55.d67fba02.js"><link rel="prefetch" href="/assets/js/56.beac5e77.js"><link rel="prefetch" href="/assets/js/57.4de3d728.js"><link rel="prefetch" href="/assets/js/58.cecb3823.js"><link rel="prefetch" href="/assets/js/59.2ec1381f.js"><link rel="prefetch" href="/assets/js/6.b38701ec.js"><link rel="prefetch" href="/assets/js/60.fed14f90.js"><link rel="prefetch" href="/assets/js/61.fed6147c.js"><link rel="prefetch" href="/assets/js/62.0583a533.js"><link rel="prefetch" href="/assets/js/63.da61b917.js"><link rel="prefetch" href="/assets/js/64.ae259b46.js"><link rel="prefetch" href="/assets/js/65.7de73bc1.js"><link rel="prefetch" href="/assets/js/66.bad1db68.js"><link rel="prefetch" href="/assets/js/67.d092e753.js"><link rel="prefetch" href="/assets/js/68.4f358bb8.js"><link rel="prefetch" href="/assets/js/69.087f8831.js"><link rel="prefetch" href="/assets/js/7.b6d31f4a.js"><link rel="prefetch" href="/assets/js/70.b49f2502.js"><link rel="prefetch" href="/assets/js/71.f15d3809.js"><link rel="prefetch" href="/assets/js/72.ebf1c946.js"><link rel="prefetch" href="/assets/js/73.205df904.js"><link rel="prefetch" href="/assets/js/74.76d73623.js"><link rel="prefetch" href="/assets/js/75.81c76e90.js"><link rel="prefetch" href="/assets/js/76.ec39a638.js"><link rel="prefetch" href="/assets/js/9.ef330b20.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2d0603d3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar boxshadow"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Marcin Jahn | Technology Notebook</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/programming/" class="nav-link">
  Programming
</a></div><div class="nav-item"><a href="/dev-tools/" class="nav-link">
  Dev Tools
</a></div><div class="nav-item"><a href="/computers/" class="nav-link router-link-active">
  Computers
</a></div><div class="nav-item"><a href="/meta/" class="nav-link">
  Meta
</a></div> <span class="external-services" data-v-6c2342f8><a target="_blank" href="https://www.linkedin.com/in/marcin-jahn-63a9b915b" data-v-dca26bee data-v-6c2342f8><img src="/img/linkedin.webp" data-v-dca26bee></a><a target="_blank" href="https://github.com/marcinjahn" data-v-dca26bee data-v-6c2342f8><img src="/img/github.webp" data-v-dca26bee></a></span> <a href="https://github.com/marcinjahn/knowledge-website" target="_blank" rel="noopener noreferrer" class="repo-link">
    Code on GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/programming/" class="nav-link">
  Programming
</a></div><div class="nav-item"><a href="/dev-tools/" class="nav-link">
  Dev Tools
</a></div><div class="nav-item"><a href="/computers/" class="nav-link router-link-active">
  Computers
</a></div><div class="nav-item"><a href="/meta/" class="nav-link">
  Meta
</a></div> <span class="external-services" data-v-6c2342f8><a target="_blank" href="https://www.linkedin.com/in/marcin-jahn-63a9b915b" data-v-dca26bee data-v-6c2342f8><img src="/img/linkedin.webp" data-v-dca26bee></a><a target="_blank" href="https://github.com/marcinjahn" data-v-dca26bee data-v-6c2342f8><img src="/img/github.webp" data-v-dca26bee></a></span> <a href="https://github.com/marcinjahn/knowledge-website" target="_blank" rel="noopener noreferrer" class="repo-link">
    Code on GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/computers/" aria-current="page" class="sidebar-link">/computers/</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web Protocols</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Security</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/computers/security/basic-terms.html" class="sidebar-link">Cryptography Basics</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>TPM</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/computers/security/tpm/overview.html" class="sidebar-link">Overiew</a></li><li><a href="/computers/security/tpm/tpm-entities.html" class="sidebar-link">TPM Entities</a></li><li><a href="/computers/security/tpm/tpm-operations.html" aria-current="page" class="active sidebar-link">TPM Operations</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/computers/security/tpm/tpm-operations.html#generating-random-numbers" class="sidebar-link">Generating Random Numbers</a></li><li class="sidebar-sub-header"><a href="/computers/security/tpm/tpm-operations.html#generating-keys" class="sidebar-link">Generating Keys</a></li><li class="sidebar-sub-header"><a href="/computers/security/tpm/tpm-operations.html#using-keys" class="sidebar-link">Using Keys</a></li><li class="sidebar-sub-header"><a href="/computers/security/tpm/tpm-operations.html#ownership" class="sidebar-link">Ownership</a></li><li class="sidebar-sub-header"><a href="/computers/security/tpm/tpm-operations.html#measured-boot" class="sidebar-link">Measured Boot</a></li><li class="sidebar-sub-header"><a href="/computers/security/tpm/tpm-operations.html#authorization" class="sidebar-link">Authorization</a></li></ul></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content"><div class="content__default"><h1 id="tpm-operations"><a href="#tpm-operations" class="header-anchor">#</a> TPM Operations</h1> <h2 id="generating-random-numbers"><a href="#generating-random-numbers" class="header-anchor">#</a> Generating Random Numbers</h2> <p>The <code>TPM2_CC_GetRandom</code> command generates random bytes (max 48 per call).</p> <h2 id="generating-keys"><a href="#generating-keys" class="header-anchor">#</a> Generating Keys</h2> <p>Each hierarchy can have a primary key, which acts as a parent for all the child
keys. The children are wrapped (encrypted by the parent).</p> <p>Enrollment Primary Key is certified by the manufacturer of the TPM. It means
that the key has an accompanying certificate signed by the trusted CA. This
certificate is stored in the TPM's NVDATA. It can be read and verified any time.
The NV indices for the certs are reserved.</p> <p><img src="/assets/img/certified-key.19fec696.png" alt=""></p> <p>If EK is trusted, all keys under it can be trusted as well (chain of trust).</p> <p>The Primary Key may be recreated multiple times, it will always be the same, as
long as the provided parameters (such as key type) are the same. The EK has
predefined templates, which can be used anytime we need that key. One is for
RSA, the other for ECC.</p> <p>Keys may be stored persistently, but TPM has limited space for it.</p> <h3 id="attributes"><a href="#attributes" class="header-anchor">#</a> Attributes</h3> <p>Other than algorithm information, it is also required to provide attributes of
the new key (object). Example:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">CreatePrimary</span><span class="token punctuation">(</span>
  <span class="token constant">TPM2_RH_OWNER</span><span class="token punctuation">,</span>
  <span class="token constant">TPM2_ALG_RSA</span><span class="token punctuation">,</span>
  <span class="token comment">/*restricted=*/</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token comment">/*decrypt=*/</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token comment">/*sign=*/</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token comment">/*unique=*/</span> <span class="token string">&quot;hello&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Some of the parameters:</p> <ul><li>Decrypt (<code>TPMA_OBJECT_DECRYPT</code>) - Specifies an encryption key.</li> <li>Sign (<code>TPMA_OBJECT_SIGN_ENCRYPT</code>) - Specifies a signing key.</li> <li>Restricted (<code>TPMA_OBJECT_RESTRICTED</code>) - Restricts the key to
signing/encrypting only internal TPM data.</li></ul> <p>Non primary keys are created with the <code>TPM2_CC_Create</code> command. The command
requires a handle to the parent key.</p> <h2 id="using-keys"><a href="#using-keys" class="header-anchor">#</a> Using Keys</h2> <p>Keys generated by TPM might be used to sign, verify, encrypt, decrypt data.</p> <h2 id="ownership"><a href="#ownership" class="header-anchor">#</a> Ownership</h2> <p>Endorsement Hierarchy keys are protected by the EK (which is certified and can
be trusted). The <em>Owner Hierarchy</em> cannot be trusted in the same way, it's not
certified by the TPM manufacturer. It's the owner'a responsibility to provision
and certify the primary key of the owner hierarchy. The primary key of the owner
hierarchy is the <strong>Storage Root Key (SRK)</strong> (like in TPM 1.2?). It's a
<strong>restricted encryption key</strong>.</p> <p>Having a trusted, <strong>restricted signing key</strong> is useful for remote system
attestation. It's, therefore, recommended to create and certify a restricted
signing key during provisioning time. This trusted signing key is also called
<strong>Attestation Identity Key (AIK)</strong>.</p> <h3 id="taking-ownership"><a href="#taking-ownership" class="header-anchor">#</a> Taking Ownership</h3> <ol><li>Read and validate the EK certificate. Proceed only if you trust the vendor.</li> <li>Clear the owner hierarchy with <code>TPM2_CC_Clear</code>.</li> <li>Create a primary, restricted asymmetric encryption key on the owner hierarchy
(<code>TPM2_CC_CreatePrimary</code>). Call this the SRK.</li> <li>Certify the SRK with your enterprise CA: create a CSR with SRK public part,
and ask your internal, trusted CA to sign it. Store the certificate in NV
data (<code>TPM2_CC_NV_DefineSpace</code>, <code>TPM2_CC_NV_Write</code>). Alternatively, you can
store the SRK public key in a remote database. Use this database to verify
the SRK's authenticity in the future.</li> <li>Make the SRK persistent by evicting it to NVDATA (<code>TPM2_CC_EvitControl</code>).</li> <li>Create a restricted asymmetric signing key under the SRK (<code>TPM2_CC_Create</code>,
<code>TPM2_CC_Load</code>). Call this the <em>AIK</em>.</li> <li>Certify the AIK with your enterprise CA: create a CSR with AIK public part,
and ask your internal, trusted CA to sign it. Store the certificate in NV
data (<code>TPM2_CC_NV_DefineSpace</code>, <code>TPM2_CC_NV_Write</code>). Alternatively, you can
store the AIK public key in a remote database. Use this database to verify
the AIK's authenticity in the future. It's possible to use the SRK
certificate as root of trust for the AIK, however, having an AIK certificate
can simplify some workflows.</li> <li>Make the AIK persistent by evicting it to NVDATA (<code>TPM2_CC_EvitControl</code>).</li></ol> <p>These keys should be set as fixed (non-duplicable): use <code>TPMA_OBJECT_FIXEDTPM</code>
and <code>TPMA_OBJECT_FIXEDPARENT</code> in the <code>objectAttributes</code> field in their
templates. At this point we have two trusted keys we can use: one for storage
(protecting other TPM keys) (SRK?) and one for signing TPM statements (AIK).</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>A common practice is to set the owner hierarchy's auth value to a random string
during provisioning. It protects keys on this hierarchy against unwanted use.</p></div> <h2 id="measured-boot"><a href="#measured-boot" class="header-anchor">#</a> Measured Boot</h2> <p>It's a standardized technology supported by modern firmware. Before executing an
element in the boot sequence, it's measured to make sure that it is the expected
executable. If the result is unexpected, it's not executed.</p> <p><img src="/assets/img/pcr-measured-boot.9dc7aadf.png" alt=""></p> <p>Each element is measured by its predecessor in the sequence.
Each measurement is stored in a different PCR.</p> <h3 id="measuring-the-firmware"><a href="#measuring-the-firmware" class="header-anchor">#</a> Measuring the Firmware</h3> <p>We assume that the first element (firmware) is trusted. It measures itself into
PCR0. Vendors publish the expected measurements of their firmware.</p> <p>Another approach is to use CRTM. There's an immutable code component called
<strong>Core Root of Trust for Measurement (CRTM)</strong>. It is the first piece of code
that executes on the main processor during the boot process. It measures the
firmware blob before passing execution to it.</p> <h3 id="event-log"><a href="#event-log" class="header-anchor">#</a> Event Log</h3> <p>There is a log that gives some details about measurements sent to TPM. It's
maintained by the firmware, bootloader and the OS. Users can read the log to see
what was measured.</p> <p>Log example:</p> <div class="language-log extra-class"><pre class="language-log"><code>Fimware blob <span class="token string">&quot;firmware.bin&quot;</span><span class="token punctuation">,</span> PCR8<span class="token punctuation">,</span> digest<span class="token operator">=</span><span class="token number">0x11223344</span><span class="token punctuation">.</span>
Boot app <span class="token string">&quot;/EFI/Windows/Bootloader.efi&quot;</span><span class="token punctuation">,</span> PCR8<span class="token punctuation">,</span> digest<span class="token operator">=</span><span class="token number">0x55667788</span><span class="token punctuation">.</span>
Kernel image <span class="token string">&quot;c:\Windows\ntoskrnl.exe&quot;</span><span class="token punctuation">,</span> PCR8<span class="token punctuation">,</span> digest<span class="token operator">=</span><span class="token number">0x99AABBCC</span><span class="token punctuation">.</span>
</code></pre></div><p>Thanks to Measured Boot a <strong>Remote Attestation</strong> may be done. It checks the
integrity of a system.</p> <h2 id="authorization"><a href="#authorization" class="header-anchor">#</a> Authorization</h2> <p>TPM may be used only with the right authorization. Authorization policies are
used. Many authorization schemes are supported (e.g. a password scheme).
Autorization value may be set for the entire hierarchy or on individual keys.</p> <p>An example of authorizing before calling a command:</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">SetAuthPassword</span><span class="token punctuation">(</span><span class="token string">&quot;secret-password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> key <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>
  primary<span class="token punctuation">.</span>handle<span class="token punctuation">,</span>
  <span class="token constant">TPM2_ALG_RSA</span><span class="token punctuation">,</span>
  <span class="token comment">/*restricted=*/</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token comment">/*decrypt=*/</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token comment">/*sign=*/</span> <span class="token number">0</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>When more than three attempts of authorization fail, TPM enters <strong>locked-out</strong>
mode. It protects against a dictionary attack. It will not accept any command
for the target object in that state.</p> <h3 id="session-authorization"><a href="#session-authorization" class="header-anchor">#</a> Session Authorization</h3> <p><strong>Session</strong> is an internal TPM object that encodes an authorization value. A
session has a digest of PCRs. When creating a data/key in TPM, we can specify
what is the expected PCR digest. If the session's digest matches the one
expected by the data/key it is accessible.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/marcinjahn/knowledge-website/edit/main/src/docs/computers/security/tpm/tpm-operations.md" target="_blank" rel="noopener noreferrer">Feel free to contribute to this article!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/21/2021, 10:30:33 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/computers/security/tpm/tpm-entities.html" class="prev">
        TPM Entities
      </a></span> <!----></p></div></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.87cbde57.js" defer></script><script src="/assets/js/2.f59378ff.js" defer></script><script src="/assets/js/8.f2bdf25f.js" defer></script>
  </body>
</html>
