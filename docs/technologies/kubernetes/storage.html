<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Storage | Marcin Jahn | Technology Notebook</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-ZSM2N36X8P"></script>
    <script>(function() { if (window.location.href.startsWith('http://localhost')) { return; } window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-ZSM2N36X8P'); })();</script>
    <meta name="description" content="Various ways to persist data in Kubernetes">
    <meta property="og:url" content="/technologies/kubernetes/storage.html">
    <meta property="og:site_name" content="Marcin Jahn | Technology Notebook">
    <meta property="og:title" content="Storage">
    <meta property="og:description" content="Various ways to persist data in Kubernetes">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="Marcin Jahn | Technology Notebook">
    <meta property="article:author" content="Marcin Jahn">
    <meta name="theme-color" content="white">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.b737cf3e.css" as="style"><link rel="preload" href="/assets/js/app.394986f0.js" as="script"><link rel="preload" href="/assets/js/2.3d0e1f49.js" as="script"><link rel="preload" href="/assets/js/113.dc119d5e.js" as="script"><link rel="prefetch" href="/assets/js/10.286e8cb9.js"><link rel="prefetch" href="/assets/js/100.31d772fe.js"><link rel="prefetch" href="/assets/js/101.102f4b17.js"><link rel="prefetch" href="/assets/js/102.46e76745.js"><link rel="prefetch" href="/assets/js/103.9aed96e4.js"><link rel="prefetch" href="/assets/js/104.80f66d47.js"><link rel="prefetch" href="/assets/js/105.6363a69c.js"><link rel="prefetch" href="/assets/js/106.533721d5.js"><link rel="prefetch" href="/assets/js/107.4f92e956.js"><link rel="prefetch" href="/assets/js/108.0d07cf19.js"><link rel="prefetch" href="/assets/js/109.ba91fe16.js"><link rel="prefetch" href="/assets/js/11.68cc34a7.js"><link rel="prefetch" href="/assets/js/110.351bef52.js"><link rel="prefetch" href="/assets/js/111.1310d3dd.js"><link rel="prefetch" href="/assets/js/112.c94803bb.js"><link rel="prefetch" href="/assets/js/114.e01cd65b.js"><link rel="prefetch" href="/assets/js/115.cd6e3634.js"><link rel="prefetch" href="/assets/js/116.4fbcd594.js"><link rel="prefetch" href="/assets/js/117.0188ca3e.js"><link rel="prefetch" href="/assets/js/118.401a5f35.js"><link rel="prefetch" href="/assets/js/119.da11a72c.js"><link rel="prefetch" href="/assets/js/12.d906b391.js"><link rel="prefetch" href="/assets/js/120.0edb5202.js"><link rel="prefetch" href="/assets/js/121.762d133c.js"><link rel="prefetch" href="/assets/js/122.56615127.js"><link rel="prefetch" href="/assets/js/123.e365f48d.js"><link rel="prefetch" href="/assets/js/124.1e773eed.js"><link rel="prefetch" href="/assets/js/125.ea5653ef.js"><link rel="prefetch" href="/assets/js/126.612eff10.js"><link rel="prefetch" href="/assets/js/127.156b107b.js"><link rel="prefetch" href="/assets/js/128.1cbd06ca.js"><link rel="prefetch" href="/assets/js/13.ffb80372.js"><link rel="prefetch" href="/assets/js/14.8ee943e7.js"><link rel="prefetch" href="/assets/js/15.a79d2e5e.js"><link rel="prefetch" href="/assets/js/16.af490693.js"><link rel="prefetch" href="/assets/js/17.8235b8a5.js"><link rel="prefetch" href="/assets/js/18.1b51f4cf.js"><link rel="prefetch" href="/assets/js/19.4c979b7f.js"><link rel="prefetch" href="/assets/js/20.d8cbfe1d.js"><link rel="prefetch" href="/assets/js/21.14008443.js"><link rel="prefetch" href="/assets/js/22.f9e94c1e.js"><link rel="prefetch" href="/assets/js/23.eb86d43a.js"><link rel="prefetch" href="/assets/js/24.cdbcbf8c.js"><link rel="prefetch" href="/assets/js/25.d3c33607.js"><link rel="prefetch" href="/assets/js/26.85e5f3bb.js"><link rel="prefetch" href="/assets/js/27.16b3b4a3.js"><link rel="prefetch" href="/assets/js/28.b5b03efe.js"><link rel="prefetch" href="/assets/js/29.2318a36e.js"><link rel="prefetch" href="/assets/js/3.7436c0e0.js"><link rel="prefetch" href="/assets/js/30.ea7ebaf8.js"><link rel="prefetch" href="/assets/js/31.166aeb14.js"><link rel="prefetch" href="/assets/js/32.36e4280b.js"><link rel="prefetch" href="/assets/js/33.bb537880.js"><link rel="prefetch" href="/assets/js/34.25fbe5f7.js"><link rel="prefetch" href="/assets/js/35.b62c761d.js"><link rel="prefetch" href="/assets/js/36.55979790.js"><link rel="prefetch" href="/assets/js/37.ff413b13.js"><link rel="prefetch" href="/assets/js/38.37e9bef7.js"><link rel="prefetch" href="/assets/js/39.c0e67fa8.js"><link rel="prefetch" href="/assets/js/4.efeb791b.js"><link rel="prefetch" href="/assets/js/40.1871caf7.js"><link rel="prefetch" href="/assets/js/41.f6ca2f1a.js"><link rel="prefetch" href="/assets/js/42.a4870e94.js"><link rel="prefetch" href="/assets/js/43.f02bf073.js"><link rel="prefetch" href="/assets/js/44.b818c454.js"><link rel="prefetch" href="/assets/js/45.168602b4.js"><link rel="prefetch" href="/assets/js/46.6440943b.js"><link rel="prefetch" href="/assets/js/47.07244462.js"><link rel="prefetch" href="/assets/js/48.912075dc.js"><link rel="prefetch" href="/assets/js/49.c88ecdd0.js"><link rel="prefetch" href="/assets/js/5.20eb6e1d.js"><link rel="prefetch" href="/assets/js/50.4df16dbd.js"><link rel="prefetch" href="/assets/js/51.964061d1.js"><link rel="prefetch" href="/assets/js/52.aa043f73.js"><link rel="prefetch" href="/assets/js/53.e536701d.js"><link rel="prefetch" href="/assets/js/54.8d738aed.js"><link rel="prefetch" href="/assets/js/55.5f5cd957.js"><link rel="prefetch" href="/assets/js/56.43cc95de.js"><link rel="prefetch" href="/assets/js/57.b5e9edaa.js"><link rel="prefetch" href="/assets/js/58.cf5e5081.js"><link rel="prefetch" href="/assets/js/59.1f277e17.js"><link rel="prefetch" href="/assets/js/6.d4448905.js"><link rel="prefetch" href="/assets/js/60.6f34ba64.js"><link rel="prefetch" href="/assets/js/61.985478e6.js"><link rel="prefetch" href="/assets/js/62.97bff9ac.js"><link rel="prefetch" href="/assets/js/63.17327893.js"><link rel="prefetch" href="/assets/js/64.e56b3f93.js"><link rel="prefetch" href="/assets/js/65.6895d0b6.js"><link rel="prefetch" href="/assets/js/66.3cbb3bd5.js"><link rel="prefetch" href="/assets/js/67.747c67e0.js"><link rel="prefetch" href="/assets/js/68.89e521a0.js"><link rel="prefetch" href="/assets/js/69.0e586e86.js"><link rel="prefetch" href="/assets/js/7.44762843.js"><link rel="prefetch" href="/assets/js/70.6e533f5f.js"><link rel="prefetch" href="/assets/js/71.f4ffd8c6.js"><link rel="prefetch" href="/assets/js/72.f0713b22.js"><link rel="prefetch" href="/assets/js/73.47cd1bff.js"><link rel="prefetch" href="/assets/js/74.e55141ad.js"><link rel="prefetch" href="/assets/js/75.7ba8cef3.js"><link rel="prefetch" href="/assets/js/76.9e10d927.js"><link rel="prefetch" href="/assets/js/77.f4ee14a6.js"><link rel="prefetch" href="/assets/js/78.933a9eae.js"><link rel="prefetch" href="/assets/js/79.91387bcc.js"><link rel="prefetch" href="/assets/js/8.3c883f34.js"><link rel="prefetch" href="/assets/js/80.884ea4f2.js"><link rel="prefetch" href="/assets/js/81.338c4f52.js"><link rel="prefetch" href="/assets/js/82.a470df7f.js"><link rel="prefetch" href="/assets/js/83.8d052b48.js"><link rel="prefetch" href="/assets/js/84.0c94d8cf.js"><link rel="prefetch" href="/assets/js/85.be4e3a07.js"><link rel="prefetch" href="/assets/js/86.5b824a94.js"><link rel="prefetch" href="/assets/js/87.8b376b59.js"><link rel="prefetch" href="/assets/js/88.42562c78.js"><link rel="prefetch" href="/assets/js/89.79d19672.js"><link rel="prefetch" href="/assets/js/9.36524c28.js"><link rel="prefetch" href="/assets/js/90.a67c6322.js"><link rel="prefetch" href="/assets/js/91.f593c81f.js"><link rel="prefetch" href="/assets/js/92.57c1a335.js"><link rel="prefetch" href="/assets/js/93.90e86825.js"><link rel="prefetch" href="/assets/js/94.a7a382b3.js"><link rel="prefetch" href="/assets/js/95.9bfb809b.js"><link rel="prefetch" href="/assets/js/96.00c09acb.js"><link rel="prefetch" href="/assets/js/97.90a83b7c.js"><link rel="prefetch" href="/assets/js/98.c040acdd.js"><link rel="prefetch" href="/assets/js/99.2d8fd68d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b737cf3e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar boxshadow"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Marcin Jahn | Technology Notebook</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/programming/" class="nav-link">
  Programming
</a></div><div class="nav-item"><a href="/technologies/" class="nav-link router-link-active">
  Technologies
</a></div><div class="nav-item"><a href="/projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="/meta/" class="nav-link">
  Meta
</a></div> <span class="external-services" data-v-10a38898><a target="_blank" href="https://www.linkedin.com/in/marcin-jahn-63a9b915b/?locale=en_US" data-v-f9b87572 data-v-10a38898><img src="/img/linkedin.webp" data-v-f9b87572></a><a target="_blank" href="https://github.com/marcinjahn" data-v-f9b87572 data-v-10a38898><img src="/img/github.webp" data-v-f9b87572></a></span> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/programming/" class="nav-link">
  Programming
</a></div><div class="nav-item"><a href="/technologies/" class="nav-link router-link-active">
  Technologies
</a></div><div class="nav-item"><a href="/projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="/meta/" class="nav-link">
  Meta
</a></div> <span class="external-services" data-v-10a38898><a target="_blank" href="https://www.linkedin.com/in/marcin-jahn-63a9b915b/?locale=en_US" data-v-f9b87572 data-v-10a38898><img src="/img/linkedin.webp" data-v-f9b87572></a><a target="_blank" href="https://github.com/marcinjahn" data-v-f9b87572 data-v-10a38898><img src="/img/github.webp" data-v-f9b87572></a></span> <!----></nav>  <ul class="sidebar-links"><li><a href="/technologies/" aria-current="page" class="sidebar-link">/technologies/</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web Protocols</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Security</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Blockchain</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Kubernetes</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/technologies/kubernetes/meaning.html" class="sidebar-link">Meaning and Purpose</a></li><li><a href="/technologies/kubernetes/cluster.html" class="sidebar-link">Cluster</a></li><li><a href="/technologies/kubernetes/dev-env.html" class="sidebar-link">Dev Environment</a></li><li><a href="/technologies/kubernetes/api.html" class="sidebar-link">Kubernetes API</a></li><li><a href="/technologies/kubernetes/objects.html" class="sidebar-link">Objects</a></li><li><a href="/technologies/kubernetes/pods.html" class="sidebar-link">Pods</a></li><li><a href="/technologies/kubernetes/scaling.html" class="sidebar-link">Scaling</a></li><li><a href="/technologies/kubernetes/events.html" class="sidebar-link">Events</a></li><li><a href="/technologies/kubernetes/storage.html" aria-current="page" class="active sidebar-link">Storage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technologies/kubernetes/storage.html#volumes" class="sidebar-link">Volumes</a></li></ul></li><li><a href="/technologies/kubernetes/configuration.html" class="sidebar-link">Configuration</a></li><li><a href="/technologies/kubernetes/organization.html" class="sidebar-link">Organizing Objects</a></li><li><a href="/technologies/kubernetes/services.html" class="sidebar-link">Services</a></li><li><a href="/technologies/kubernetes/ingress.html" class="sidebar-link">Ingress</a></li><li><a href="/technologies/kubernetes/helm.html" class="sidebar-link">Helm</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SQL Server</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Ansible</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Azure</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content"><div class="content__default"><h1 id="storage"><a href="#storage" class="header-anchor">#</a> Storage</h1> <p>Stateful applications require storage to be attached to its pods.</p> <h2 id="volumes"><a href="#volumes" class="header-anchor">#</a> Volumes</h2> <p><img src="https://i.imgur.com/nPKhzLL.png" alt=""></p> <p><img src="https://i.imgur.com/qMFmqlN.png" alt=""></p> <p>Volume types:</p> <ul><li>emptyDir - a simple directory. Preserved for the pod existence time. Multiple
containers in a pod can share data this way. It can be backed by a dir on a
node, or tmpfs on a node</li> <li>hostPath - worker node's path. It's dangerous, because pod may get access to
all files on the node.</li> <li>nfs</li> <li>azureFile</li> <li>azureDisk</li> <li>persistentVolumeClaim</li> <li>...</li></ul> <p>Different types have different configuration options. E.g., <code>emptyDir</code> can have
&quot;medium&quot; and &quot;sizeLimit&quot; configured.</p> <p>Volumes can be mounted as read/write, or read-only. In multi-mount situations,
depending on the provider, only one, or many pods can write to the same volume.</p> <h3 id="persistent-volumes"><a href="#persistent-volumes" class="header-anchor">#</a> Persistent Volumes</h3> <p>The direct volume mounting described above is problematic, because it exposes
the details about the volume to pod/deployment definition (e.g., I'd have to
specify the URL of NFS storage there, or I have to specify that Azure infra is
used for storage). This makes the manifests tied to a specific cloud provider.</p> <p><img src="https://i.imgur.com/tH4mCzX.png" alt=""></p> <p>Additional objects were introduced to abstract the storage info away:</p> <p><img src="https://i.imgur.com/vN89M9j.png" alt=""></p> <p>The volume providing is divided between two personas:</p> <ul><li>cluster admins - defines available <em>PersistentVolumes</em></li> <li>cluster user/dev - requests storage for their app using
<em>PersistentVolumeClaim</em>.</li></ul> <p>Storage objects:</p> <ul><li><strong>Persistent Volume</strong> - represents a storage volume; it stores information
about it;</li> <li><strong>Persistent Volume Claim</strong> - represents user's claim on the persistent
volume. Its lifecycle is not tied to that of a pod, so the ownership of the
persistent volume is decoupled from the pod. To use a persistent volume, user
first needs to claim it. When the volume is no longer needed, the user
releases it by deleting the claim object.</li></ul> <p>To use the volume, pod needs to refer to a PersistentVolumeClaim that is bound
to a PersistentVolume. The claim might either reference exact name of the
PersistentVolume, or just list requirements to allow K8s to bind any fitting
PersistentVolume to it.</p> <p>Multiple pods can use the same volume by referencing the same claim. Depending
on the storage type, access will be enabled or not. E.g., some storage providers
allow writing from one node only (so multiple pods on that node can write). Other
nodes cannot write.</p> <p>PV that is ready to be claimed has &quot;Available&quot; status.</p> <h4 id="reclaim-policies"><a href="#reclaim-policies" class="header-anchor">#</a> Reclaim Policies</h4> <p>PV can configure its reclaim policy:</p> <ul><li><strong>Retain</strong> - when PVC is deleted, the PV becomes &quot;Released&quot;, the volume is
retained. Admin must manually remove it. If a PV is claimed, and then the PVC
is deleted, the PV's Status becomes &quot;Released&quot;, it cannot be claimed in this
state. It can be claimed again if the object gets edited and the
<code>.spec.claimRef</code> gets removed (or the whole PV needs to be deleted and then
recreated). If PV gets deleted, the data stays intact.</li> <li><strong>Delete</strong> - when PVC is deleted, the PV and the underlying data are deleted
as well. It is used with the automatically provisioned PVs.</li></ul> <p>PV is just a pointer to the data.</p> <h4 id="access-modes"><a href="#access-modes" class="header-anchor">#</a> Access Modes</h4> <p>Access Modes of a PersistentVolume refer to how many nodes can mount it (not
pods). Types:</p> <ul><li><em>ReadWriteOnce</em> - only one node can mount it in read/write mode. Others can't
mount it at all.</li> <li><em>ReadOnlyMany</em> - many nodes can mount it in read-only mode</li> <li><em>ReadWriteMany</em> - many nodes can mount it in read/write mode.</li></ul> <p>A PersistentVolume can support multiple modes.</p> <h4 id="deletion"><a href="#deletion" class="header-anchor">#</a> Deletion</h4> <p>Deleting a PV will await for a bound PVC to be deleted. Deleting a PVC will
await for a bound pod to be deleted.</p> <h4 id="auto-provisioning"><a href="#auto-provisioning" class="header-anchor">#</a> Auto Provisioning</h4> <p>PersistentVolumes might also be created automatically on-demand as needed, if
the automated provisioner is installed (e.g. AKS creates Azure Disk
automatically when it's needed).</p> <p><img src="https://i.imgur.com/UT7ZnCU.png" alt=""></p> <p>Here, the order gets reversed. Instead of creating a PVC for a pre-existing PV,
a PVC gets created first, and then a proper PV gets created by a provisioner.</p> <h5 id="storage-class"><a href="#storage-class" class="header-anchor">#</a> Storage Class</h5> <p>Cloud provider offers some <em>StorageClasses</em> (e.g. Azure offers AzureDisk and
AzureFile). A PVC should contain information which StorageClass it expects.</p> <p>The PVC uses <code>storageClassName</code> to choose Storage Class. If it's ommited, cloud
providers have some default choice. Setting <code>storageClassName</code> to <code>&quot;&quot;</code> disables
dynamic provisioning and causes an existing PV to be selected for binding.</p> <p>Depending on K8s implementation, creating new PVC with some storageClass will
instantiate the PV immediately, or only after some pod actually will need some
storage (using our PVC). E.g., GKE will create PV immediately, while kind will
wait for pod. This is because kind create local storage and it needs to know
where a pod will be scheduled (on which node) to create the storage there. The
behaviour is controlled with the &quot;volume binding mode&quot; config of a storage
class.</p> <p>We can define our own storageClasses.</p></div> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/technologies/kubernetes/events.html" class="prev">
        Events
      </a></span> <span class="next"><a href="/technologies/kubernetes/configuration.html">
        Configuration
      </a>
      →
    </span></p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/14/2022, 4:14:11 PM</span></div></footer> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.394986f0.js" defer></script><script src="/assets/js/2.3d0e1f49.js" defer></script><script src="/assets/js/113.dc119d5e.js" defer></script>
  </body>
</html>
