<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Scaling | Marcin Jahn | Technology Notebook</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-ZSM2N36X8P"></script>
    <script>(function() { if (window.location.href.startsWith('http://localhost')) { return; } window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-ZSM2N36X8P'); })();</script>
    <meta name="description" content="ReplicaSet and Deployment objects in Kubernetes">
    <meta property="og:url" content="/technologies/kubernetes/scaling.html">
    <meta property="og:site_name" content="Marcin Jahn | Technology Notebook">
    <meta property="og:title" content="Scaling">
    <meta property="og:description" content="ReplicaSet and Deployment objects in Kubernetes">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="Marcin Jahn | Technology Notebook">
    <meta property="article:author" content="Marcin Jahn">
    <meta name="theme-color" content="white">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.f7c29e46.css" as="style"><link rel="preload" href="/assets/js/app.9fc8dacc.js" as="script"><link rel="preload" href="/assets/js/2.18edd8c5.js" as="script"><link rel="preload" href="/assets/js/26.112c5f0d.js" as="script"><link rel="prefetch" href="/assets/js/10.ce6d466c.js"><link rel="prefetch" href="/assets/js/100.e859dba1.js"><link rel="prefetch" href="/assets/js/101.4220bd8a.js"><link rel="prefetch" href="/assets/js/102.dae3407f.js"><link rel="prefetch" href="/assets/js/103.cd933263.js"><link rel="prefetch" href="/assets/js/104.56f7159a.js"><link rel="prefetch" href="/assets/js/105.a9c64c2b.js"><link rel="prefetch" href="/assets/js/106.974f9094.js"><link rel="prefetch" href="/assets/js/107.a7135e71.js"><link rel="prefetch" href="/assets/js/108.372bc0c6.js"><link rel="prefetch" href="/assets/js/109.5c640d36.js"><link rel="prefetch" href="/assets/js/11.13b2fbc8.js"><link rel="prefetch" href="/assets/js/110.b9949624.js"><link rel="prefetch" href="/assets/js/111.284262c0.js"><link rel="prefetch" href="/assets/js/112.b7f784c9.js"><link rel="prefetch" href="/assets/js/113.c49203ec.js"><link rel="prefetch" href="/assets/js/114.4aede23c.js"><link rel="prefetch" href="/assets/js/115.421c1fec.js"><link rel="prefetch" href="/assets/js/116.5ae05dbf.js"><link rel="prefetch" href="/assets/js/117.c259304b.js"><link rel="prefetch" href="/assets/js/118.b448dd18.js"><link rel="prefetch" href="/assets/js/119.a1ba7338.js"><link rel="prefetch" href="/assets/js/12.54db5004.js"><link rel="prefetch" href="/assets/js/120.ea7929e8.js"><link rel="prefetch" href="/assets/js/121.3e429b9c.js"><link rel="prefetch" href="/assets/js/122.02b5f17b.js"><link rel="prefetch" href="/assets/js/123.518333fc.js"><link rel="prefetch" href="/assets/js/124.7a3837a4.js"><link rel="prefetch" href="/assets/js/125.cda2e296.js"><link rel="prefetch" href="/assets/js/126.9559cf00.js"><link rel="prefetch" href="/assets/js/127.5de561ae.js"><link rel="prefetch" href="/assets/js/128.20f5d38a.js"><link rel="prefetch" href="/assets/js/129.977c0cff.js"><link rel="prefetch" href="/assets/js/13.57631bbe.js"><link rel="prefetch" href="/assets/js/130.8fe98b08.js"><link rel="prefetch" href="/assets/js/131.b72e7c02.js"><link rel="prefetch" href="/assets/js/132.04eb4728.js"><link rel="prefetch" href="/assets/js/133.80d2484e.js"><link rel="prefetch" href="/assets/js/134.2c4c19b8.js"><link rel="prefetch" href="/assets/js/135.e540520b.js"><link rel="prefetch" href="/assets/js/14.b351f348.js"><link rel="prefetch" href="/assets/js/15.2bbc8a11.js"><link rel="prefetch" href="/assets/js/16.1ddaaf73.js"><link rel="prefetch" href="/assets/js/17.e23212ff.js"><link rel="prefetch" href="/assets/js/18.a7a3ff6a.js"><link rel="prefetch" href="/assets/js/19.9f6d2e8b.js"><link rel="prefetch" href="/assets/js/20.34505e05.js"><link rel="prefetch" href="/assets/js/21.a88f5a07.js"><link rel="prefetch" href="/assets/js/22.a1ab1482.js"><link rel="prefetch" href="/assets/js/23.5adc588a.js"><link rel="prefetch" href="/assets/js/24.e8904f8d.js"><link rel="prefetch" href="/assets/js/25.de8b3079.js"><link rel="prefetch" href="/assets/js/27.842928bb.js"><link rel="prefetch" href="/assets/js/28.25fe555f.js"><link rel="prefetch" href="/assets/js/29.2ad4fc02.js"><link rel="prefetch" href="/assets/js/3.b96fc79d.js"><link rel="prefetch" href="/assets/js/30.86fb7e3b.js"><link rel="prefetch" href="/assets/js/31.75394991.js"><link rel="prefetch" href="/assets/js/32.c3909132.js"><link rel="prefetch" href="/assets/js/33.28ca68ef.js"><link rel="prefetch" href="/assets/js/34.2f2ba09a.js"><link rel="prefetch" href="/assets/js/35.ebeec5e2.js"><link rel="prefetch" href="/assets/js/36.4439a44e.js"><link rel="prefetch" href="/assets/js/37.7b06f2d4.js"><link rel="prefetch" href="/assets/js/38.567408d3.js"><link rel="prefetch" href="/assets/js/39.2f8fe57a.js"><link rel="prefetch" href="/assets/js/4.78773ae0.js"><link rel="prefetch" href="/assets/js/40.241cbc86.js"><link rel="prefetch" href="/assets/js/41.2ee8e40e.js"><link rel="prefetch" href="/assets/js/42.24badbc9.js"><link rel="prefetch" href="/assets/js/43.ddba98d6.js"><link rel="prefetch" href="/assets/js/44.efa315a4.js"><link rel="prefetch" href="/assets/js/45.dc7bc1d5.js"><link rel="prefetch" href="/assets/js/46.fd30fea3.js"><link rel="prefetch" href="/assets/js/47.38ba6646.js"><link rel="prefetch" href="/assets/js/48.e2c3cecf.js"><link rel="prefetch" href="/assets/js/49.b239f817.js"><link rel="prefetch" href="/assets/js/5.c8cb4608.js"><link rel="prefetch" href="/assets/js/50.cb9b658d.js"><link rel="prefetch" href="/assets/js/51.4f932982.js"><link rel="prefetch" href="/assets/js/52.c260fc62.js"><link rel="prefetch" href="/assets/js/53.17949a0b.js"><link rel="prefetch" href="/assets/js/54.6450145e.js"><link rel="prefetch" href="/assets/js/55.6e0b192a.js"><link rel="prefetch" href="/assets/js/56.ccf840c2.js"><link rel="prefetch" href="/assets/js/57.d20294a5.js"><link rel="prefetch" href="/assets/js/58.e46d3a69.js"><link rel="prefetch" href="/assets/js/59.1febcdea.js"><link rel="prefetch" href="/assets/js/6.d9137468.js"><link rel="prefetch" href="/assets/js/60.9382a2e4.js"><link rel="prefetch" href="/assets/js/61.2e0591d9.js"><link rel="prefetch" href="/assets/js/62.ed82a589.js"><link rel="prefetch" href="/assets/js/63.63caba36.js"><link rel="prefetch" href="/assets/js/64.5401c411.js"><link rel="prefetch" href="/assets/js/65.8ff40a3c.js"><link rel="prefetch" href="/assets/js/66.5c934b3e.js"><link rel="prefetch" href="/assets/js/67.3fed4336.js"><link rel="prefetch" href="/assets/js/68.3146cce5.js"><link rel="prefetch" href="/assets/js/69.64562cf2.js"><link rel="prefetch" href="/assets/js/7.28a8eecf.js"><link rel="prefetch" href="/assets/js/70.2c413772.js"><link rel="prefetch" href="/assets/js/71.fe7e6f14.js"><link rel="prefetch" href="/assets/js/72.039f37d9.js"><link rel="prefetch" href="/assets/js/73.b57ad0f5.js"><link rel="prefetch" href="/assets/js/74.7deed08a.js"><link rel="prefetch" href="/assets/js/75.fde38adb.js"><link rel="prefetch" href="/assets/js/76.b65e9ac8.js"><link rel="prefetch" href="/assets/js/77.c4129088.js"><link rel="prefetch" href="/assets/js/78.b09c3cab.js"><link rel="prefetch" href="/assets/js/79.91400b79.js"><link rel="prefetch" href="/assets/js/8.e4bf253d.js"><link rel="prefetch" href="/assets/js/80.d64d4c73.js"><link rel="prefetch" href="/assets/js/81.d46d4bae.js"><link rel="prefetch" href="/assets/js/82.e367219e.js"><link rel="prefetch" href="/assets/js/83.abfe5abd.js"><link rel="prefetch" href="/assets/js/84.f831bc61.js"><link rel="prefetch" href="/assets/js/85.1a43cf00.js"><link rel="prefetch" href="/assets/js/86.4902805a.js"><link rel="prefetch" href="/assets/js/87.a3809b48.js"><link rel="prefetch" href="/assets/js/88.0daf9315.js"><link rel="prefetch" href="/assets/js/89.6f506db4.js"><link rel="prefetch" href="/assets/js/9.d41adc85.js"><link rel="prefetch" href="/assets/js/90.06b200e0.js"><link rel="prefetch" href="/assets/js/91.c85092ad.js"><link rel="prefetch" href="/assets/js/92.de12986a.js"><link rel="prefetch" href="/assets/js/93.f81a9264.js"><link rel="prefetch" href="/assets/js/94.560f6839.js"><link rel="prefetch" href="/assets/js/95.c47b9c5c.js"><link rel="prefetch" href="/assets/js/96.8510e3e7.js"><link rel="prefetch" href="/assets/js/97.26277591.js"><link rel="prefetch" href="/assets/js/98.9826a4ea.js"><link rel="prefetch" href="/assets/js/99.593bc618.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f7c29e46.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar boxshadow"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Marcin Jahn | Technology Notebook</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/programming/" class="nav-link">
  Programming
</a></div><div class="nav-item"><a href="/technologies/" class="nav-link router-link-active">
  Technologies
</a></div><div class="nav-item"><a href="/projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="/meta/" class="nav-link">
  Meta
</a></div> <span class="external-services" data-v-10a38898><a target="_blank" href="https://www.linkedin.com/in/marcin-jahn-63a9b915b/?locale=en_US" data-v-f9b87572 data-v-10a38898><img src="/img/linkedin.webp" data-v-f9b87572></a><a target="_blank" href="https://github.com/marcinjahn" data-v-f9b87572 data-v-10a38898><img src="/img/github.webp" data-v-f9b87572></a></span> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/programming/" class="nav-link">
  Programming
</a></div><div class="nav-item"><a href="/technologies/" class="nav-link router-link-active">
  Technologies
</a></div><div class="nav-item"><a href="/projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="/meta/" class="nav-link">
  Meta
</a></div> <span class="external-services" data-v-10a38898><a target="_blank" href="https://www.linkedin.com/in/marcin-jahn-63a9b915b/?locale=en_US" data-v-f9b87572 data-v-10a38898><img src="/img/linkedin.webp" data-v-f9b87572></a><a target="_blank" href="https://github.com/marcinjahn" data-v-f9b87572 data-v-10a38898><img src="/img/github.webp" data-v-f9b87572></a></span> <!----></nav>  <ul class="sidebar-links"><li><a href="/technologies/" aria-current="page" class="sidebar-link">/technologies/</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web Protocols</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Security</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Blockchain</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Kubernetes</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/technologies/kubernetes/meaning.html" class="sidebar-link">Meaning and Purpose</a></li><li><a href="/technologies/kubernetes/cluster.html" class="sidebar-link">Cluster</a></li><li><a href="/technologies/kubernetes/dev-env.html" class="sidebar-link">Dev Environment</a></li><li><a href="/technologies/kubernetes/api.html" class="sidebar-link">Kubernetes API</a></li><li><a href="/technologies/kubernetes/objects.html" class="sidebar-link">Objects</a></li><li><a href="/technologies/kubernetes/pods.html" class="sidebar-link">Pods</a></li><li><a href="/technologies/kubernetes/scaling.html" aria-current="page" class="active sidebar-link">Scaling</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technologies/kubernetes/scaling.html#replicaset" class="sidebar-link">ReplicaSet</a></li><li class="sidebar-sub-header"><a href="/technologies/kubernetes/scaling.html#deployment" class="sidebar-link">Deployment</a></li><li class="sidebar-sub-header"><a href="/technologies/kubernetes/scaling.html#pods-deletion" class="sidebar-link">Pods Deletion</a></li><li class="sidebar-sub-header"><a href="/technologies/kubernetes/scaling.html#logs" class="sidebar-link">Logs</a></li><li class="sidebar-sub-header"><a href="/technologies/kubernetes/scaling.html#strategies-of-deployment" class="sidebar-link">Strategies of deployment</a></li></ul></li><li><a href="/technologies/kubernetes/events.html" class="sidebar-link">Events</a></li><li><a href="/technologies/kubernetes/storage.html" class="sidebar-link">Storage</a></li><li><a href="/technologies/kubernetes/configuration.html" class="sidebar-link">Configuration</a></li><li><a href="/technologies/kubernetes/organization.html" class="sidebar-link">Organizing Objects</a></li><li><a href="/technologies/kubernetes/services.html" class="sidebar-link">Services</a></li><li><a href="/technologies/kubernetes/ingress.html" class="sidebar-link">Ingress</a></li><li><a href="/technologies/kubernetes/helm.html" class="sidebar-link">Helm</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SQL Server</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MongoDB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Ansible</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Azure</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content"><div class="content__default"><h1 id="scaling"><a href="#scaling" class="header-anchor">#</a> Scaling</h1> <p>It's not very convenient to manage pods individually. We need ways to deploy
pods in multiple replicas, which is a base for high availability of the service.
Additionally, we need a way to keep pods running in case some node fails.</p> <h2 id="replicaset"><a href="#replicaset" class="header-anchor">#</a> ReplicaSet</h2> <p>ReplicaSet allows us to create a group of pod replicas, instead of just one pod.
The pods managed by the ReplicaSet are selected using an immutable label
<code>selector</code> (similarly to <a href="/technologies/kubernetes/services.html">Services</a>). There is also a <code>template</code>,
which defines the pod(s) that will be created under ReplicaSet. Such a pod has
to conform to the <em>selector</em> specified by the ReplicaSet.</p> <div class="custom-block tip"><p class="custom-block-title">Existing Pods</p> <p>If some pods matching the selector already existed prior to the creation of the
ReplicaSet, they're counted as part of the ReplicaSet.</p> <p>If we manually create some pod(s) that conform to ReplicaSet's selector, the
controller will delete some pods to reach the <em>replicas</em> count.</p></div> <p>Pod names are generated based on the ReplicaSet's name, but it can be changed
with the <code>generateName</code> setting.</p> <div class="custom-block tip"><p class="custom-block-title">ReplicationController</p> <p>In the past, ReplicationController was used instead of ReplicaSet. It behaved
the same as ReplicaSet does. It is now deprecated.</p></div> <p>ReplicaSets are rarely used directly due to their lacking pods updates
possibilities.</p> <h3 id="updates"><a href="#updates" class="header-anchor">#</a> Updates</h3> <p>We're free to change <code>replicas</code> count and the number of pods will reflect the
setting.</p> <p>If we modify the <code>template</code> of some existing ReplicaSet, the existing pods will
not be updated. Instead, just the pods created by ReplicaSet in the future will
have the new settings applied.</p> <h3 id="replacing-a-pod"><a href="#replacing-a-pod" class="header-anchor">#</a> Replacing a Pod</h3> <p>Sometimes we might want to investigate some issue in one of the pods, while
keeping ReplicaSet running with proper scaling. We could temporarily increment
the <em>replicas</em> config, but we'd have to rememeber to decrement it back later on.
Instead, we can just change the labels of the faulty pod so that it does not
conform to ReplicaSet's selector. The ReplicaSet's controller will create a new
pod for its needs while we can start investigating the faulty pod.</p> <h3 id="ownership"><a href="#ownership" class="header-anchor">#</a> Ownership</h3> <p>Pods managed by a ReplicaSet have a special
&quot;ownerReference&quot; section in their &quot;metadata&quot;. A pod can have multiple owners.</p> <p>Pods are auto-deleted when the owners are deleted (unless the <code>--cascade=orphan</code>
parameter is applied while removing the owner).</p> <p>If a pod is taken out of the ReplicaSet (like <a href="#replacing-a-pod">this</a>) the
&quot;ownerReference&quot; metadata is deleted from it automatically.</p> <h2 id="deployment"><a href="#deployment" class="header-anchor">#</a> Deployment</h2> <p>Deployments manage Pods via a ReplicaSet. They are mostly used for stateless
workloads. Labels applied in the <code>template</code> for Pods are also applied to the
ReplicaSet that manages these pods.</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><div class="custom-block tip"><p class="custom-block-title">ReplicaSet Updates</p> <p>If we try to edit ReplicaSet managed by a Deployment, our updates will be
replaced with Deployment's config soon after. ReplicaSet is controlled by the
Deployment and we should modify its settings throught the Deployment.</p></div> <p>In addition to settings available to ReplicaSets, Deployments also contain the
<code>strategy</code> configuration. It dictates how Pods are replaced during updates.</p> <div class="custom-block tip"><p class="custom-block-title">Existing Pods</p> <p>If some pods already exist that match the Deployment's selector, most likely
they will not be reused in the Deployment's replicas. The ReplicaSet managed by
the Deployment adds additional (based on <code>template</code> hash) label selector to
the pods it manages.</p> <p><img src="/assets/img/deployment-replicaset-selector.249cfc6d.png" alt=""></p></div> <h3 id="updates-2"><a href="#updates-2" class="header-anchor">#</a> Updates</h3> <p>Compared to ReplicaSets, updating Pod template causes all the existing Pods to
be redeployed to meet the new requirements. Anytime we update Pod's template a
hash of it is calculated, and a new ReplicaSet is created with that hash being
used for one of the selectors.</p> <h4 id="strategies"><a href="#strategies" class="header-anchor">#</a> Strategies</h4> <p>There are two update strategies supported by the Deployment:</p> <ul><li><p><strong>Recreat</strong> - all pods deleted at the same time. There is some downtime until
the new pods get created. It should be used when downtime is acceptable or
when apps should not run in mixed versions</p></li> <li><p><strong>RollingUpdate</strong> - old pods are gradually replaced with new ones. It's the
<strong>default</strong>. The number of pods to be replaced at a time is configurable:</p> <ul><li><strong>maxSurge</strong> - the maximum number of pods above the configured <code>replicas</code>
to be run during the update. The deployment may run more pods than desired
replicas to keep the app available during the update. It's an absolute
number or percentage. The default is <strong>25%</strong>.</li> <li><strong>maxUnavailable</strong> - the max number of Pods (realtive to <code>replicas</code>) that
may be unavailable during the update.It's an absolute number or
percentage. The default is <strong>25%</strong>.</li></ul> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>We can't set both <strong>maxSurge</strong> and <strong>maxUnavailable</strong> to 0.</p></div></li></ul> <h4 id="pausing"><a href="#pausing" class="header-anchor">#</a> Pausing</h4> <p>Pausing might be useful for:</p> <ul><li>checking the state of the app in-between the update to see how mixed versions
work.</li> <li>applying multiple update operations without immediate action from the
deployment-controller.</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># Pause</span>
k rollout pause deployment my-deployment

<span class="token comment"># Resume</span>
k rollout resume deployment my-deployment
</code></pre></div><h4 id="rollback"><a href="#rollback" class="header-anchor">#</a> Rollback</h4> <p>If deployment update rollout is failing, we can rollback with:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>k rollout undo deployment my-deployment
</code></pre></div><p>If the deployment is paused, rollback will also be paused.</p> <div class="custom-block warning"><p class="custom-block-title">Only template</p> <p>Rollback reverts only changes made to the <code>template</code> section of the Deployment.
All other changes, such as <code>strategy</code> or <code>replicas</code> are preserved.</p> <p>A <code>k apply</code> command would overwrite everything.</p></div> <h5 id="history"><a href="#history" class="header-anchor">#</a> History</h5> <p>We can rollback to older versions as well.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># To see a list of revisions</span>
k rollout <span class="token function">history</span> deploy my-deployment

<span class="token comment"># To see details of some revision</span>
k rollout <span class="token function">history</span> deploy my-deployment --revision <span class="token number">2</span>

<span class="token comment"># To rollback to some revision</span>
k rollout undo deploy my-deployment --to-revision<span class="token operator">=</span><span class="token number">2</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">ReplicaSet</p> <p>The history of deployments is persisted thanks to the fact that ReplicaSets of
the Deployment are preserved after updates. The amount of old ReplicaSets to
keep is configable with the <code>spec.revisionHistoryLimit</code> setting of the
Deployment.</p></div> <h3 id="restart"><a href="#restart" class="header-anchor">#</a> Restart</h3> <p>We can restart all pods of a deployment with:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>k rollout restart deploy my-deployment
</code></pre></div><p>All the pods are deleted and replaced with new ones. The <code>strategy</code> setting is
respected.</p> <h3 id="example"><a href="#example" class="header-anchor">#</a> Example</h3> <p>Creating a simple deployment: <code>kubectl create deployment kiada --image=luksa/kiada:0.1</code></p> <p>Kubectl sends a POST request to <code>/deployments</code> of K8s API to create a
<em>Deployment</em> object. Kubernetes creates a <em>Pod</em> object based on Deployment. The
pod is assigned to a Worker Node. Kubelet on a worker node pulls the image and
runs the container.</p> <p>We can track a deployment with <code>k rollout status deployment my-deployment</code>.</p> <h3 id="scaling-2"><a href="#scaling-2" class="header-anchor">#</a> Scaling</h3> <p><code>kubectl scale deployment kiada --replicas=3</code></p> <p>It makes sense to skip <code>replicas</code> setting from the manifest file of the
deploment. This way, when we reapply the manifest in the future, the <code>replicas</code>
setting will not be overwritten to the default again.</p> <h3 id="ownership-2"><a href="#ownership-2" class="header-anchor">#</a> Ownership</h3> <p>Similarly to ReplicaSet, deletion of the Deploymeny auto-removes the ReplicaSet
and the Pods. To circumvent that, we can use the <code>--cascade=orphan</code> parameter -
it will preserve both the Pods and ReplicaSet. In such a case, when we recreate
the deployment, the existing ReplicaSet/Pods are reused.</p> <h2 id="pods-deletion"><a href="#pods-deletion" class="header-anchor">#</a> Pods Deletion</h2> <p>When scaling down, K8s selects pods to delete based on some priorities:</p> <ul><li>pods that are not started</li> <li>pods collocated on the same node with greater number of replicas</li> <li>pods that lived shorter</li> <li>pods with a greater number of restarts</li></ul> <p>We can also influence the priority by applying <code>pod-deletion-cost</code> annotation to
specific pods.</p> <h2 id="logs"><a href="#logs" class="header-anchor">#</a> Logs</h2> <p>There is no easy way to display logs from all the pods in a ReplicaSet/Deployment.
Instead, we have to use label selector:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>k logs -l <span class="token assign-left variable">app</span><span class="token operator">=</span>myapp --prefix --all-containers
</code></pre></div><ul><li><code>--prefix</code> prefixes each log with the container that it came from</li> <li><code>--all-containers</code> displays logs from all containers of the pods</li></ul> <h2 id="strategies-of-deployment"><a href="#strategies-of-deployment" class="header-anchor">#</a> Strategies of deployment</h2> <p>Here're the popular deployment strategies. Some of them are supported by K8s
out-of-the-box, some are not.</p> <ul><li><strong>Recreate</strong> - remove all pods, create all new pods</li> <li><strong>Rolling update</strong> - gradually replace pods</li> <li><strong>Canary</strong> - replace a small number of pods, if the new ones work well, replace the rest</li> <li><strong>A/B testing</strong> - create a small number of new pods, redirect some users
(based on some condition) to the new pods.</li> <li><strong>Blue/Green</strong> - deploy new pods in parallel with the old ones. When the new
ones are ready, switch all the traffic to the new ones. Then delete the old
Pods.</li> <li><strong>Shadowing</strong> - deploy new pods in parallel with the old ones. Route all user
traffic to both versions, but return to the users just the responses from the
old version. In the meanitme, observe the responses from the new ones to make
sure that they work as expected.</li></ul> <p>Only the first two strategies are supported by K8s. The other strategies require
some manual work.</p> <h3 id="canary"><a href="#canary" class="header-anchor">#</a> Canary</h3> <p>We can create a separate deployment with the new version and scale it to low
number of replicas. The labels of the new pods should match the <code>selector</code> of
the Service that was used for the old version. This way, the new pods are added
to the pool ofw pods behind the service. If we see that the new version works, we
can go ahead and update the old deployment and delete the canary one.</p> <h3 id="a-b-testing"><a href="#a-b-testing" class="header-anchor">#</a> A/B Testing</h3> <p>Some Ingress controllers have this capability.</p> <h3 id="blue-green"><a href="#blue-green" class="header-anchor">#</a> Blue/Green</h3> <p>We create a separate deployment with the new versions (Green). We do not route
any traffic at these. All the traffic still hits the old deployment (Blue). When
we're ready, we'd change the <code>selector</code> of the Service to match the label
configured in the Green deployment. Then, we delete the Blue deployment.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>We could use label values &quot;green&quot; and &quot;blue&quot; and switch from one to another in
consecutive updates. So, first we'd start with &quot;blue&quot; and swith to &quot;green&quot;. With
some next update we'd switch from &quot;green&quot; to &quot;blue&quot;. And so on.</p></div></div> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/technologies/kubernetes/pods.html" class="prev">
        Pods
      </a></span> <span class="next"><a href="/technologies/kubernetes/events.html">
        Events
      </a>
      →
    </span></p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/25/2022, 7:54:33 PM</span></div></footer> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.9fc8dacc.js" defer></script><script src="/assets/js/2.18edd8c5.js" defer></script><script src="/assets/js/26.112c5f0d.js" defer></script>
  </body>
</html>
