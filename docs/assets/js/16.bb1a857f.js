(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{455:function(t,e,a){t.exports=a.p+"assets/img/certified-key.19fec696.png"},456:function(t,e,a){t.exports=a.p+"assets/img/pcr-measured-boot.9dc7aadf.png"},581:function(t,e,a){"use strict";a.r(e);var s=a(31),n=Object(s.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"tpm-operations"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tpm-operations"}},[t._v("#")]),t._v(" TPM Operations")]),t._v(" "),s("h2",{attrs:{id:"generating-random-numbers"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#generating-random-numbers"}},[t._v("#")]),t._v(" Generating Random Numbers")]),t._v(" "),s("p",[t._v("The "),s("code",[t._v("TPM2_CC_GetRandom")]),t._v(" command generates random bytes (max 48 per call).")]),t._v(" "),s("h2",{attrs:{id:"generating-keys"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#generating-keys"}},[t._v("#")]),t._v(" Generating Keys")]),t._v(" "),s("p",[t._v("Each hierarchy can have a primary key, which acts as a parent for all the child\nkeys. The children are wrapped (encrypted by the parent).")]),t._v(" "),s("p",[t._v("Enrollment Primary Key is certified by the manufacturer of the TPM. It means\nthat the key has an accompanying certificate signed by the trusted CA. This\ncertificate is stored in the TPM's NVDATA. It can be read and verified any time.\nThe NV indices for the certs are reserved.")]),t._v(" "),s("p",[s("img",{attrs:{src:a(455),alt:""}})]),t._v(" "),s("p",[t._v("If EK is trusted, all keys under it can be trusted as well (chain of trust).")]),t._v(" "),s("p",[t._v("The Primary Key may be recreated multiple times, it will always be the same, as\nlong as the provided parameters (such as key type) are the same. The EK has\npredefined templates, which can be used anytime we need that key. One is for\nRSA, the other for ECC.")]),t._v(" "),s("p",[t._v("Keys may be stored persistently, but TPM has limited space for it.")]),t._v(" "),s("h3",{attrs:{id:"attributes"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#attributes"}},[t._v("#")]),t._v(" Attributes")]),t._v(" "),s("p",[t._v("Other than algorithm information, it is also required to provide attributes of\nthe new key (object). Example:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CreatePrimary")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TPM2_RH_OWNER")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TPM2_ALG_RSA")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*restricted=*/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*decrypt=*/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*sign=*/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*unique=*/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hello"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("Some of the parameters:")]),t._v(" "),s("ul",[s("li",[t._v("Decrypt ("),s("code",[t._v("TPMA_OBJECT_DECRYPT")]),t._v(") - Specifies an encryption key.")]),t._v(" "),s("li",[t._v("Sign ("),s("code",[t._v("TPMA_OBJECT_SIGN_ENCRYPT")]),t._v(") - Specifies a signing key.")]),t._v(" "),s("li",[t._v("Restricted ("),s("code",[t._v("TPMA_OBJECT_RESTRICTED")]),t._v(") - Restricts the key to\nsigning/encrypting only internal TPM data.")])]),t._v(" "),s("p",[t._v("Non primary keys are created with the "),s("code",[t._v("TPM2_CC_Create")]),t._v(" command. The command\nrequires a handle to the parent key.")]),t._v(" "),s("h2",{attrs:{id:"using-keys"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#using-keys"}},[t._v("#")]),t._v(" Using Keys")]),t._v(" "),s("p",[t._v("Keys generated by TPM might be used to sign, verify, encrypt, decrypt data.")]),t._v(" "),s("h2",{attrs:{id:"ownership"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ownership"}},[t._v("#")]),t._v(" Ownership")]),t._v(" "),s("p",[t._v("Endorsement Hierarchy keys are protected by the EK (which is certified and can\nbe trusted). The "),s("em",[t._v("Owner Hierarchy")]),t._v(" cannot be trusted in the same way, it's not\ncertified by the TPM manufacturer. It's the owner'a responsibility to provision\nand certify the primary key of the owner hierarchy. The primary key of the owner\nhierarchy is the "),s("strong",[t._v("Storage Root Key (SRK)")]),t._v(" (like in TPM 1.2?). It's a\n"),s("strong",[t._v("restricted encryption key")]),t._v(".")]),t._v(" "),s("p",[t._v("Having a trusted, "),s("strong",[t._v("restricted signing key")]),t._v(" is useful for remote system\nattestation. It's, therefore, recommended to create and certify a restricted\nsigning key during provisioning time. This trusted signing key is also called\n"),s("strong",[t._v("Attestation Identity Key (AIK)")]),t._v(".")]),t._v(" "),s("h3",{attrs:{id:"taking-ownership"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#taking-ownership"}},[t._v("#")]),t._v(" Taking Ownership")]),t._v(" "),s("ol",[s("li",[t._v("Read and validate the EK certificate. Proceed only if you trust the vendor.")]),t._v(" "),s("li",[t._v("Clear the owner hierarchy with "),s("code",[t._v("TPM2_CC_Clear")]),t._v(".")]),t._v(" "),s("li",[t._v("Create a primary, restricted asymmetric encryption key on the owner hierarchy\n("),s("code",[t._v("TPM2_CC_CreatePrimary")]),t._v("). Call this the SRK.")]),t._v(" "),s("li",[t._v("Certify the SRK with your enterprise CA: create a CSR with SRK public part,\nand ask your internal, trusted CA to sign it. Store the certificate in NV\ndata ("),s("code",[t._v("TPM2_CC_NV_DefineSpace")]),t._v(", "),s("code",[t._v("TPM2_CC_NV_Write")]),t._v("). Alternatively, you can\nstore the SRK public key in a remote database. Use this database to verify\nthe SRK's authenticity in the future.")]),t._v(" "),s("li",[t._v("Make the SRK persistent by evicting it to NVDATA ("),s("code",[t._v("TPM2_CC_EvitControl")]),t._v(").")]),t._v(" "),s("li",[t._v("Create a restricted asymmetric signing key under the SRK ("),s("code",[t._v("TPM2_CC_Create")]),t._v(",\n"),s("code",[t._v("TPM2_CC_Load")]),t._v("). Call this the "),s("em",[t._v("AIK")]),t._v(".")]),t._v(" "),s("li",[t._v("Certify the AIK with your enterprise CA: create a CSR with AIK public part,\nand ask your internal, trusted CA to sign it. Store the certificate in NV\ndata ("),s("code",[t._v("TPM2_CC_NV_DefineSpace")]),t._v(", "),s("code",[t._v("TPM2_CC_NV_Write")]),t._v("). Alternatively, you can\nstore the AIK public key in a remote database. Use this database to verify\nthe AIK's authenticity in the future. It's possible to use the SRK\ncertificate as root of trust for the AIK, however, having an AIK certificate\ncan simplify some workflows.")]),t._v(" "),s("li",[t._v("Make the AIK persistent by evicting it to NVDATA ("),s("code",[t._v("TPM2_CC_EvitControl")]),t._v(").")])]),t._v(" "),s("p",[t._v("These keys should be set as fixed (non-duplicable): use "),s("code",[t._v("TPMA_OBJECT_FIXEDTPM")]),t._v("\nand "),s("code",[t._v("TPMA_OBJECT_FIXEDPARENT")]),t._v(" in the "),s("code",[t._v("objectAttributes")]),t._v(" field in their\ntemplates. At this point we have two trusted keys we can use: one for storage\n(protecting other TPM keys) (SRK?) and one for signing TPM statements (AIK).")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("A common practice is to set the owner hierarchy's auth value to a random string\nduring provisioning. It protects keys on this hierarchy against unwanted use.")])]),t._v(" "),s("h2",{attrs:{id:"measured-boot"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#measured-boot"}},[t._v("#")]),t._v(" Measured Boot")]),t._v(" "),s("p",[t._v("It's a standardized technology supported by modern firmware. Before executing an\nelement in the boot sequence, it's measured to make sure that it is the expected\nexecutable. If the result is unexpected, it's not executed.")]),t._v(" "),s("p",[s("img",{attrs:{src:a(456),alt:""}})]),t._v(" "),s("p",[t._v("Each element is measured by its predecessor in the sequence.\nEach measurement is stored in a different PCR.")]),t._v(" "),s("h3",{attrs:{id:"measuring-the-firmware"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#measuring-the-firmware"}},[t._v("#")]),t._v(" Measuring the Firmware")]),t._v(" "),s("p",[t._v("We assume that the first element (firmware) is trusted. It measures itself into\nPCR0. Vendors publish the expected measurements of their firmware.")]),t._v(" "),s("p",[t._v("Another approach is to use CRTM. There's an immutable code component called\n"),s("strong",[t._v("Core Root of Trust for Measurement (CRTM)")]),t._v(". It is the first piece of code\nthat executes on the main processor during the boot process. It measures the\nfirmware blob before passing execution to it.")]),t._v(" "),s("h3",{attrs:{id:"event-log"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#event-log"}},[t._v("#")]),t._v(" Event Log")]),t._v(" "),s("p",[t._v("There is a log that gives some details about measurements sent to TPM. It's\nmaintained by the firmware, bootloader and the OS. Users can read the log to see\nwhat was measured.")]),t._v(" "),s("p",[t._v("Log example:")]),t._v(" "),s("div",{staticClass:"language-log extra-class"},[s("pre",{pre:!0,attrs:{class:"language-log"}},[s("code",[t._v("Fimware blob "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"firmware.bin"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" PCR8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" digest"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x11223344")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\nBoot app "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/EFI/Windows/Bootloader.efi"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" PCR8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" digest"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x55667788")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\nKernel image "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"c:\\Windows\\ntoskrnl.exe"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" PCR8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" digest"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x99AABBCC")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])])]),s("p",[t._v("Thanks to Measured Boot a "),s("strong",[t._v("Remote Attestation")]),t._v(" may be done. It checks the\nintegrity of a system.")]),t._v(" "),s("h2",{attrs:{id:"authorization"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#authorization"}},[t._v("#")]),t._v(" Authorization")]),t._v(" "),s("p",[t._v("TPM may be used only with the right authorization. Authorization policies are\nused. Many authorization schemes are supported (e.g. a password scheme).\nAutorization value may be set for the entire hierarchy or on individual keys.")]),t._v(" "),s("p",[t._v("An example of authorizing before calling a command:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("SetAuthPassword")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"secret-password"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" key "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Create")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  primary"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("handle"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TPM2_ALG_RSA")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*restricted=*/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*decrypt=*/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*sign=*/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("When more than three attempts of authorization fail, TPM enters "),s("strong",[t._v("locked-out")]),t._v("\nmode. It protects against a dictionary attack. It will not accept any command\nfor the target object in that state.")]),t._v(" "),s("h3",{attrs:{id:"session-authorization"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#session-authorization"}},[t._v("#")]),t._v(" Session Authorization")]),t._v(" "),s("p",[s("strong",[t._v("Session")]),t._v(" is an internal TPM object that encodes an authorization value. A\nsession has a digest of PCRs. When creating a data/key in TPM, we can specify\nwhat is the expected PCR digest. If the session's digest matches the one\nexpected by the data/key it is accessible.")])])}),[],!1,null,null,null);e.default=n.exports}}]);