(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{524:function(t,e,s){"use strict";s.r(e);var a=s(22),o=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"identity-in-asp-net-core"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#identity-in-asp-net-core"}},[t._v("#")]),t._v(" Identity in ASP.NET Core")]),t._v(" "),s("p",[t._v("ASP.NET Core has a built-in identity system that allows to use:")]),t._v(" "),s("ul",[s("li",[t._v("internal accounts - stored in our database (by default SQL acessed with EF Core)")]),t._v(" "),s("li",[t._v("external accounts with OpenId Connect")])]),t._v(" "),s("p",[t._v("There is middleware for:")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("Authentication")]),t._v(" - sets the "),s("code",[t._v("User")]),t._v(" property of "),s("code",[t._v("HttpContext")]),t._v(" if the user is\nrecognized (e.g. via a cookie or token). It uses authentication services to\nrecognize the user.")]),t._v(" "),s("li",[s("strong",[t._v("Authorization")]),t._v(" - checks if the endpoint's requirements are fulfilled. If not,\nthe request is short-circuited.")])]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("Middleware Order")]),t._v(" "),s("p",[t._v("The Authorization middleware has to be executed after Routing and\nAuthentication. Thanks to Routing, the Authorizatin middleware knows what are\nthe requirements of the endpoint (the "),s("code",[t._v("[Authorize]")]),t._v(" attributes). Thanks to\nAuthentication, the "),s("code",[t._v("User")]),t._v(" property of "),s("code",[t._v("HttpContext")]),t._v(" is set.")])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("Authorization Filter")]),t._v(" "),s("p",[t._v("Prior to ASP.NET Core 3.0, there was no "),s("code",[t._v("AuthorizationMiddleware")]),t._v(". Instead, an\nAuthorization filter was used.")])]),t._v(" "),s("h2",{attrs:{id:"razor-pages"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#razor-pages"}},[t._v("#")]),t._v(" Razor Pages")]),t._v(" "),s("p",[t._v("There is a UI package that contains various account management pages to be used\nwith internal accounts. They can be overriden to customize them.")]),t._v(" "),s("h2",{attrs:{id:"httpcontext"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#httpcontext"}},[t._v("#")]),t._v(" HttpContext")]),t._v(" "),s("p",[t._v("The "),s("code",[t._v("HttpContext")]),t._v(" contains the "),s("code",[t._v("User")]),t._v(" property, which is configured via the\nAuthentication middleware. It contains all the claims of the logged-in user.")]),t._v(" "),s("h2",{attrs:{id:"authorizeattribute"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#authorizeattribute"}},[t._v("#")]),t._v(" AuthorizeAttribute")]),t._v(" "),s("p",[t._v("The "),s("code",[t._v("AuthorizeAttribute")]),t._v(" may be applied:")]),t._v(" "),s("ul",[s("li",[t._v("globally")]),t._v(" "),s("li",[t._v("on controller")]),t._v(" "),s("li",[t._v("on action")]),t._v(" "),s("li",[t._v("on Razor Page")])]),t._v(" "),s("p",[t._v("If it's applied globally, but we want to allow anonymous access to some selected\nendpoint (e.g. login page), we can use the "),s("code",[t._v("AllowAnonymousAttribute")]),t._v(" to that\nendppoint.")]),t._v(" "),s("p",[t._v("Options:")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("[Authorize]")]),t._v(" - require the user to be logged and nothing more")]),t._v(" "),s("li",[s("code",[t._v("[Authorize(Admin)]")]),t._v(" - require the "),s("code",[t._v("Admin")]),t._v(" policy to be satisfied")])]),t._v(" "),s("p",[t._v("The policies are defined in the "),s("code",[t._v("Program.cs")]),t._v("/"),s("code",[t._v("Startup.cs")]),t._v(" file:")]),t._v(" "),s("div",{staticClass:"language-csharp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-csharp"}},[s("code",[t._v("services"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddAuthorization")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddPolicy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Admin"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" policyBuilder "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        policyBuilder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("RequireClaim")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"IsAdmin"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("Some other solutions, like Open Policy Agent, store policies and execute them\nexternally from the app's code being protected (e.g. in a sidecar).")])]),t._v(" "),s("p",[t._v("The "),s("code",[t._v("[Authorize]")]),t._v(" attribute may be applied to an endpoint multiple times. In\nsuch a case all of them have to be satisfied (AND).")]),t._v(" "),s("h2",{attrs:{id:"forbidden-access"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#forbidden-access"}},[t._v("#")]),t._v(" Forbidden Access")]),t._v(" "),s("p",[t._v("Web Apps with UI redirect the user to the login page (if user not logged in) or\nreturn a message that access is denied (if user doesn't meet requirements).")]),t._v(" "),s("p",[t._v("Web APIs return 401 when no access token is attached or 403 if the token doesn't\nhave the required claims.")]),t._v(" "),s("h2",{attrs:{id:"roles-vs-claims"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#roles-vs-claims"}},[t._v("#")]),t._v(" Roles vs Claims")]),t._v(" "),s("p",[t._v("Nowadays, it is recommended to use the Claims-based authorization, although the\nRoles-based model is also available.")]),t._v(" "),s("h2",{attrs:{id:"resouce-based-authorization"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#resouce-based-authorization"}},[t._v("#")]),t._v(" Resouce-based Authorization")]),t._v(" "),s("p",[t._v("Sometimes, to figure out if access shoud be granted, lookin over caller's claims\nis not enough. We might have to call the database and check if the requested\ndata belongs to the caller. This requires imperative code instead of declarative\nway of applying the "),s("code",[t._v("[Authorize]")]),t._v(" attribute.")]),t._v(" "),s("p",[t._v("The action/Page that requires such authorization can use the\n"),s("code",[t._v("IAuthorizationService")]),t._v(" (via DI). It allows us to easily execute policies that\nwe define for our resources during the action/Page execution. It returns either\nsuccess or fail result, which we can use to either continue execution or return\n"),s("code",[t._v("ForbidResult")]),t._v(".")]),t._v(" "),s("p",[t._v("To define such custom policies, we need "),s("code",[t._v("IAuthorizationRequirement")]),t._v("(s) and\n"),s("code",[t._v("AuthorizationHandler<T,U>")]),t._v(". We also need to registed the policy in bootstrap.")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("Business Logic")]),t._v(" "),s("p",[t._v("It might be undesirable to depend on ASP.NET Core's components (like\n"),s("code",[t._v("IAuthorizationService")]),t._v(") in our business logic. In such case we could create the\nauthorization logic entirely on our own.")])])])}),[],!1,null,null,null);e.default=o.exports}}]);