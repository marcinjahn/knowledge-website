---
import './style.css';
import sidebarStructure from "../../static/sidebar";
import { getCollection } from "astro:content";
import LinkNode from "./LinkNode.astro";
import NodeWithChildren from "./NodeWithChildren.astro";

function getSectionItems(path: string) {
    const section = Object.keys(sidebarStructure).find((key) =>
        path.startsWith(key)
    ) as string;
    return { items: sidebarStructure[section] || [], basePath: section };
}

const { items, basePath } = getSectionItems(Astro.url.pathname);
const allArticles = await getCollection("articles");

function slug(endOfPath: string) {
    return `${basePath}${endOfPath}`
}

function getArticleTitle(endOfPath: string) {
    const articleSlug = slug(endOfPath).substring(1);
    const title = allArticles
        .find(a => a.slug === articleSlug || a.slug + '/' === articleSlug)
        ?.data.title;

    return title ?? "UNKNOWN"
}
---

<ul>
    {
        items.map((item) =>
            typeof item === "string" ? (
                <LinkNode path={slug(item)} title={getArticleTitle(item)}/>
            ) : (
            <NodeWithChildren item={item} isTopLevel={true}>
                {item.children.map((item) =>
                    typeof item === "string" ? (
                    <LinkNode path={slug(item)} title={getArticleTitle(item)}/>
                    ) : (
                    <NodeWithChildren item={item}>
                        {item.children.map((item) =>
                            typeof item === "string" ? (
                            <LinkNode path={slug(item)} title={getArticleTitle(item)}/>
                            ) : (
                                <NodeWithChildren item={item}>
                                    {item.children.map(
                                        (item) => (
                                            typeof item === "string" ? (
                                            <LinkNode path={slug(item)} title={getArticleTitle(item)}/>
                                            ) : (<></>)
                                        )
                                    )}
                                </NodeWithChildren>
                            )
                        )}
                    </NodeWithChildren>
                    )
                )}
            </NodeWithChildren>
            )
        )
    }
</ul>

<style>
    ul {
        margin-top: 0;
        padding-left: 0;
    }
</style>

<script>
    revealCurrentArticle();

    function revealCurrentArticle() {
        const path = window.location.pathname;
        const currentLi = document.querySelector(`[data-path="${path}"]`);

        if (currentLi === null) {
            return;
        }

        let parent: HTMLElement | null | undefined = currentLi.parentElement;
        while(parent) {
            parent.classList.remove('hidden');
            parent = parent.parentElement?.parentElement;
        }
    }
</script>
